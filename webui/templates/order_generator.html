{% extends "base.html" %}

{% block title %}ì£¼ë¬¸ ìƒì„± - HayDay Dynamic Balancing{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- ì ‘ì„ ìˆ˜ ìˆëŠ” ì‚¬ì´ë“œë°” -->
        <div class="col-md-3 col-lg-2" id="sidebar">
            <div class="d-flex flex-column flex-shrink-0 p-3 bg-light" style="height: 100vh;">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="fs-4">ğŸšœ HayDay</span>
                    <button class="btn btn-sm btn-outline-secondary" id="sidebarToggle">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
                <hr>
                <ul class="nav nav-pills flex-column mb-auto">
                    <li class="nav-item">
                        <a href="/" class="nav-link">
                            <i class="fas fa-home me-2"></i>ë°ì´í„° ë·°ì–´
                        </a>
                    </li>
                    <li>
                        <a href="/order-generator" class="nav-link active" aria-current="page">
                            <i class="fas fa-dice me-2"></i>ì£¼ë¬¸ ìƒì„±
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link" onclick="openStreamlit()">
                            <i class="fas fa-chart-line me-2"></i>ì‹œë®¬ë ˆì´ì…˜
                        </a>
                    </li>
                </ul>
                
                <!-- Streamlit ì—°ë™ ìƒíƒœ -->
                <div class="mt-3">
                    <small class="text-muted">ì—°ë™ ìƒíƒœ</small>
                    <div id="connectionStatus" class="badge bg-secondary">í™•ì¸ ì¤‘...</div>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <div class="col-md-9 col-lg-10" id="mainContent">
            <div class="container-fluid py-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h2">ğŸ¯ ì‹¤ì‹œê°„ ì£¼ë¬¸ ìƒì„±</h1>
                    <div>
                        <button class="btn btn-outline-primary" onclick="openStreamlit()">
                            <i class="fas fa-external-link-alt me-2"></i>Streamlit ì—´ê¸°
                        </button>
                        <button class="btn btn-primary" onclick="syncWithStreamlit()">
                            <i class="fas fa-sync me-2"></i>ë™ê¸°í™”
                        </button>
                    </div>
                </div>

                <!-- ì£¼ë¬¸ ìƒì„± ì»¨íŠ¸ë¡¤ -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">ğŸ“Š ì„¤ì •</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="playerLevel" class="form-label">í”Œë ˆì´ì–´ ë ˆë²¨</label>
                                    <input type="range" class="form-range" min="1" max="100" value="20" id="playerLevel">
                                    <div class="d-flex justify-content-between">
                                        <small>1</small>
                                        <span id="levelValue" class="fw-bold">20</span>
                                        <small>100</small>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="struggleScore" class="form-label">ì–´ë ¤ì›€ ì§€ìˆ˜</label>
                                    <input type="range" class="form-range" min="0" max="100" value="50" id="struggleScore">
                                    <div class="d-flex justify-content-between">
                                        <small>ì‰¬ì›€</small>
                                        <span id="struggleValue" class="fw-bold">50</span>
                                        <small>ì–´ë ¤ì›€</small>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="deliveryType" class="form-label">ë°°ì†¡ íƒ€ì…</label>
                                    <select class="form-select" id="deliveryType">
                                        <option value="Truck">ğŸšš íŠ¸ëŸ­</option>
                                        <option value="Train">ğŸš‚ ê¸°ì°¨</option>
                                    </select>
                                </div>

                                <button class="btn btn-primary w-100" onclick="generateOrder()">
                                    ğŸ² ì£¼ë¬¸ ìƒì„±í•˜ê¸°
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <!-- ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´í…œ ë¯¸ë¦¬ë³´ê¸° -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="card-title mb-0">ğŸ“‹ ë ˆë²¨ <span id="previewLevel">20</span>ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´í…œ</h5>
                            </div>
                            <div class="card-body">
                                <div id="availableItems" class="row">
                                    <div class="text-center text-muted">
                                        ì„¤ì •ì„ ë³€ê²½í•˜ë©´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ìƒì„±ëœ ì£¼ë¬¸ ê²°ê³¼ -->
                <div id="orderResult" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">ğŸ“¦ ì£¼ë¬¸ ì •ë³´</h5>
                                </div>
                                <div class="card-body" id="orderInfo">
                                    <!-- ì£¼ë¬¸ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">ğŸ“Š ë¶„ì„</h5>
                                </div>
                                <div class="card-body" id="orderAnalysis">
                                    <!-- ì£¼ë¬¸ ë¶„ì„ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">ğŸ›’ ì£¼ë¬¸ ì•„ì´í…œ ìƒì„¸</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped" id="orderItemsTable">
                                            <thead>
                                                <tr>
                                                    <th>ì•„ì´í…œ</th>
                                                    <th>ìˆ˜ëŸ‰</th>
                                                    <th>ë‹¨ê°€</th>
                                                    <th>ì†Œê³„</th>
                                                    <th>ìƒì‚°ì‹œê°„</th>
                                                    <th>ì–¸ë½ë ˆë²¨</th>
                                                </tr>
                                            </thead>
                                            <tbody id="orderItemsBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ì „ì—­ ë³€ìˆ˜
let currentOrder = null;

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    updateConnectionStatus();
    updateAvailableItems();
    
    // ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('playerLevel').addEventListener('input', function() {
        document.getElementById('levelValue').textContent = this.value;
        document.getElementById('previewLevel').textContent = this.value;
        updateAvailableItems();
    });
    
    document.getElementById('struggleScore').addEventListener('input', function() {
        document.getElementById('struggleValue').textContent = this.value;
    });
    
    // ì‚¬ì´ë“œë°” í† ê¸€
    document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
});

// ì‚¬ì´ë“œë°” í† ê¸€ ê¸°ëŠ¥
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const toggleBtn = document.getElementById('sidebarToggle');
    const icon = toggleBtn.querySelector('i');
    
    if (sidebar.style.display === 'none') {
        sidebar.style.display = 'block';
        mainContent.className = 'col-md-9 col-lg-10';
        icon.className = 'fas fa-chevron-left';
    } else {
        sidebar.style.display = 'none';
        mainContent.className = 'col-12';
        icon.className = 'fas fa-chevron-right';
    }
}

// Streamlit ì—°ê²° ìƒíƒœ í™•ì¸
function updateConnectionStatus() {
    fetch('/api/streamlit-sync')
        .then(response => response.json())
        .then(data => {
            const status = document.getElementById('connectionStatus');
            if (data.streamlit_status === 'online') {
                status.className = 'badge bg-success';
                status.textContent = 'ğŸŸ¢ Streamlit ì—°ê²°ë¨';
            } else {
                status.className = 'badge bg-warning';
                status.textContent = 'ğŸŸ¡ Streamlit ì˜¤í”„ë¼ì¸';
            }
        })
        .catch(error => {
            const status = document.getElementById('connectionStatus');
            status.className = 'badge bg-danger';
            status.textContent = 'ğŸ”´ ì—°ê²° ì‹¤íŒ¨';
        });
}

// Streamlit ì—´ê¸°
function openStreamlit() {
    window.open('http://localhost:8501', '_blank');
}

// Streamlitê³¼ ë™ê¸°í™”
function syncWithStreamlit() {
    if (currentOrder) {
        const syncData = {
            order: currentOrder,
            timestamp: new Date().toISOString()
        };
        
        fetch('/api/streamlit-sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(syncData)
        })
        .then(response => response.json())
        .then(data => {
            showToast('Streamlitê³¼ ë™ê¸°í™” ì™„ë£Œ!', 'success');
        })
        .catch(error => {
            showToast('ë™ê¸°í™” ì‹¤íŒ¨', 'error');
        });
    } else {
        showToast('ë™ê¸°í™”í•  ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì£¼ë¬¸ì„ ìƒì„±í•´ì£¼ì„¸ìš”.', 'warning');
    }
}

// ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´í…œ ì—…ë°ì´íŠ¸
function updateAvailableItems() {
    const level = document.getElementById('playerLevel').value;
    
    // ì„ì‹œ ë°ì´í„°ë¡œ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ (ì‹¤ì œë¡œëŠ” APIì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)
    const container = document.getElementById('availableItems');
    container.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm me-2"></div>ë¡œë”© ì¤‘...</div>';
    
    // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” API í˜¸ì¶œë¡œ ëŒ€ì²´
    setTimeout(() => {
        container.innerHTML = `
            <div class="text-muted">ë ˆë²¨ ${level}ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´í…œì„ ë³´ë ¤ë©´ ì£¼ë¬¸ì„ ìƒì„±í•´ë³´ì„¸ìš”.</div>
        `;
    }, 500);
}

// ì£¼ë¬¸ ìƒì„±
function generateOrder() {
    const level = parseInt(document.getElementById('playerLevel').value);
    const struggle = parseInt(document.getElementById('struggleScore').value);
    const delivery = document.getElementById('deliveryType').value;
    
    const requestData = {
        player_level: level,
        struggle_score: struggle,
        delivery_type: delivery
    };
    
    // ë¡œë”© í‘œì‹œ
    showToast('ì£¼ë¬¸ ìƒì„± ì¤‘...', 'info');
    
    fetch('/api/generate-order-live', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentOrder = data.order;
            displayOrder(data.order);
            displayAvailableItems(data.available_items);
            showToast('ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        } else {
            showToast('ì£¼ë¬¸ ìƒì„± ì‹¤íŒ¨: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('ì£¼ë¬¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        console.error('Error:', error);
    });
}

// ì£¼ë¬¸ ì •ë³´ í‘œì‹œ
function displayOrder(order) {
    document.getElementById('orderResult').style.display = 'block';
    
    // ì£¼ë¬¸ ê¸°ë³¸ ì •ë³´
    document.getElementById('orderInfo').innerHTML = `
        <div class="row">
            <div class="col-6">
                <strong>ì£¼ë¬¸ ID:</strong><br>
                <span class="text-primary">${order.id}</span>
            </div>
            <div class="col-6">
                <strong>ë°°ì†¡ íƒ€ì…:</strong><br>
                <span class="badge bg-info">${order.delivery_type}</span>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-6">
                <strong>ì´ ê°€ì¹˜:</strong><br>
                <span class="text-success fs-5">${order.total_value.toLocaleString()} ì½”ì¸</span>
            </div>
            <div class="col-6">
                <strong>ë‚œì´ë„:</strong><br>
                <span class="badge bg-${getDifficultyColor(order.difficulty)}">${order.difficulty}</span>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-6">
                <strong>ìš”êµ¬ ë ˆë²¨:</strong><br>
                <span>${order.level_requirement}</span>
            </div>
            <div class="col-6">
                <strong>ì–´ë ¤ì›€ ì§€ìˆ˜:</strong><br>
                <span>${order.struggle_score.toFixed(1)}</span>
            </div>
        </div>
    `;
    
    // ì£¼ë¬¸ ë¶„ì„
    document.getElementById('orderAnalysis').innerHTML = `
        <div class="row">
            <div class="col-6">
                <strong>ì•„ì´í…œ ì¢…ë¥˜:</strong><br>
                <span class="fs-5">${order.items.length}</span>
            </div>
            <div class="col-6">
                <strong>ì´ ìƒì‚°ì‹œê°„:</strong><br>
                <span class="fs-5">${order.analysis.total_production_time}ë¶„</span>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-6">
                <strong>ì˜ˆìƒ ìˆ˜ìµë¥ :</strong><br>
                <span class="text-${order.analysis.profit_margin > 0 ? 'success' : 'danger'} fs-5">
                    ${order.analysis.profit_margin.toFixed(1)}%
                </span>
            </div>
            <div class="col-6">
                <strong>ì‹œê°„ë‹¹ ìˆ˜ìµ:</strong><br>
                <span class="text-info fs-5">${order.analysis.efficiency.toFixed(1)} ì½”ì¸/ë¶„</span>
            </div>
        </div>
    `;
    
    // ì•„ì´í…œ ìƒì„¸ í…Œì´ë¸”
    const tbody = document.getElementById('orderItemsBody');
    tbody.innerHTML = '';
    
    order.items.forEach(item => {
        const row = `
            <tr>
                <td><strong>${item.item}</strong></td>
                <td>${item.quantity}</td>
                <td>${item.unit_price.toLocaleString()} ì½”ì¸</td>
                <td>${item.total_price.toLocaleString()} ì½”ì¸</td>
                <td>${item.production_time}ë¶„</td>
                <td>ë ˆë²¨ ${item.unlock_level}</td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

// ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´í…œ í‘œì‹œ
function displayAvailableItems(items) {
    const container = document.getElementById('availableItems');
    container.innerHTML = '';
    
    items.forEach(item => {
        const itemCard = `
            <div class="col-md-4 col-lg-3 mb-2">
                <div class="card card-sm">
                    <div class="card-body text-center p-2">
                        <h6 class="card-title mb-1">${item.name}</h6>
                        <small class="text-muted">
                            ğŸ”“ ë ˆë²¨ ${item.unlock_level}<br>
                            ğŸ’° ${item.price} ì½”ì¸<br>
                            â° ${item.production_time}ë¶„
                        </small>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += itemCard;
    });
}

// ë‚œì´ë„ë³„ ìƒ‰ìƒ ë°˜í™˜
function getDifficultyColor(difficulty) {
    switch(difficulty.toLowerCase()) {
        case 'veryeasy': return 'success';
        case 'easy': return 'info';
        case 'normal': return 'warning';
        case 'hard': return 'danger';
        case 'veryhard': return 'dark';
        default: return 'secondary';
    }
}

// í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
function showToast(message, type) {
    // ê°„ë‹¨í•œ alertë¡œ ëŒ€ì²´ (ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” Bootstrap Toast ì‚¬ìš©)
    const colors = {
        'success': 'âœ…',
        'error': 'âŒ', 
        'warning': 'âš ï¸',
        'info': 'â„¹ï¸'
    };
    
    alert(`${colors[type] || ''} ${message}`);
}

// ì •ê¸°ì ìœ¼ë¡œ ì—°ê²° ìƒíƒœ í™•ì¸
setInterval(updateConnectionStatus, 30000); // 30ì´ˆë§ˆë‹¤ í™•ì¸
</script>

<style>
.card-sm .card-body {
    padding: 0.5rem;
}

#sidebar {
    transition: all 0.3s ease;
}

#mainContent {
    transition: all 0.3s ease;
}

.form-range {
    cursor: pointer;
}

.table th {
    border-top: none;
    background-color: #f8f9fa;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}
</style>
{% endblock %}