{% extends "base.html" %}

{% block title %}성대모드 - Township 다이나믹 밸런싱{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="display-6 fw-bold text-primary mb-4">
            <i class="fas fa-train me-2"></i>성대모드 시뮬레이터
            <span class="badge bg-success ms-2">Township v2.1</span>
        </h1>
        <p class="lead text-muted mb-4">다이나믹 밸런싱 시스템</p>
    </div>
</div>

<div class="row">
    <!-- 시뮬레이터 컨트롤 -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cog me-2"></i>성대모드 설정
                </h5>
            </div>
            <div class="card-body">
                <!-- 플레이어 레벨 -->
                <div class="mb-3">
                    <label class="form-label">플레이어 레벨</label>
                    <input type="range" class="form-range" id="sungdae-player-level" min="1" max="100" value="5">
                    <div class="d-flex justify-content-between">
                        <small>1</small>
                        <small id="sungdae-level-display">5</small>
                        <small>100</small>
                    </div>
                </div>

                <!-- 납품 타입 선택 -->
                <div class="mb-3">
                    <label class="form-label">납품 타입</label>
                    <select class="form-select" id="sungdae-delivery-type">
                        <option value="Truck">🚚 트럭 납품</option>
                        <option value="Train">🚂 기차 납품</option>
                    </select>
                </div>

                <!-- 스트러글 스코어 수동 설정 -->
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <label class="form-label mb-0 me-2">스트러글 스코어</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="manual-struggle">
                            <label class="form-check-label" for="manual-struggle">수동</label>
                        </div>
                    </div>
                    <input type="range" class="form-range" id="sungdae-struggle-score" min="0" max="100" value="50" disabled>
                    <div class="d-flex justify-content-between">
                        <small>쉬움 (0)</small>
                        <small id="struggle-display">50</small>
                        <small>어려움 (100)</small>
                    </div>
                </div>

                <!-- 생성 버튼들 -->
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="generateSungdaeOrder()">
                        <i class="fas fa-plus me-2"></i>단일 주문 생성
                    </button>
                    <button class="btn btn-outline-primary" onclick="generateBatchOrders()">
                        <i class="fas fa-layer-group me-2"></i>배치 생성 (5개)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 다이나믹 밸런싱 상태 -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-balance-scale me-2"></i>다이나믹 밸런싱
                </h5>
            </div>
            <div class="card-body">
                <div id="dynamic-balancing-status">
                    <!-- 밸런싱 지표 -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>압력 지수</small>
                            <small id="pressure-index">-</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="pressure-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>희소성 지수</small>
                            <small id="scarcity-index">-</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="scarcity-bar" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>다양성 점수</small>
                            <small id="diversity-score">-</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="diversity-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>효율성 등급</small>
                            <small id="efficiency-rating">-</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="efficiency-bar" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- 시스템 상태 요약 -->
                    <div id="sungdae-system-status" class="mt-3 p-2 bg-light rounded">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p class="mb-0 small">초기화 중...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- 인벤토리 상태 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-boxes me-2"></i>현재 인벤토리
                    <small class="text-light ms-2" id="barn-capacity-info">Barn: -/-</small>
                </h5>
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-outline-info" onclick="refreshInventory()">
                        <i class="fas fa-sync me-1"></i>새로고침
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="openInventoryEditor()">
                        <i class="fas fa-edit me-1"></i>재고 편집
                    </button>
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-filter me-1"></i>필터
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="filterInventory('all')">전체 보기</a></li>
                        <li><a class="dropdown-item" href="#" onclick="filterInventory('deficit')">부족 아이템만</a></li>
                        <li><a class="dropdown-item" href="#" onclick="filterInventory('abundant')">풍부한 아이템만</a></li>
                    </ul>
                    <button class="btn btn-sm btn-outline-danger" onclick="resetInventory()">
                        <i class="fas fa-undo me-1"></i>초기화
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="inventory-container">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p class="mb-0">인벤토리 로딩 중...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 생성된 주문 표시 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>생성된 주문
                </h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearSungdaeOrders()">
                    <i class="fas fa-trash me-1"></i>모두 삭제
                </button>
            </div>
            <div class="card-body">
                <div id="sungdae-orders-container">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-truck fa-2x mb-2"></i>
                        <p>아직 생성된 주문이 없습니다.</p>
                        <p class="small">위의 설정을 조정하고 주문을 생성해보세요.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 다이나믹 밸런싱 시각화 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-brain me-2"></i>다이나믹 밸런싱 시스템
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- 소스 태깅 분석 -->
                    <div class="col-md-4">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-tags me-1"></i>소스 태깅 분석</h6>
                            </div>
                            <div class="card-body p-3" id="source-tagging-info">
                                <div class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <small>분석 중...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 생산 압박 분석 -->
                    <div class="col-md-4">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark py-2">
                                <h6 class="mb-0"><i class="fas fa-pressure-alt me-1"></i>생산 압박 분석</h6>
                            </div>
                            <div class="card-body p-3" id="production-pressure-info">
                                <div class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <small>분석 중...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 패턴 선정 분석 -->
                    <div class="col-md-4">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-chess me-1"></i>패턴 선정 분석</h6>
                            </div>
                            <div class="card-body p-3" id="pattern-selection-info">
                                <div class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <small>분석 중...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 실시간 밸런싱 상태 -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-chart-line me-1"></i>실시간 밸런싱 상태</h6>
                            </div>
                            <div class="card-body p-3" id="real-time-balance">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="h4 text-primary mb-1" id="struggle-score">--</div>
                                            <small class="text-muted">스트러글 스코어</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="h4 text-warning mb-1" id="deficit-ratio">--</div>
                                            <small class="text-muted">부족 비율</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="h4 text-success mb-1" id="pressure-level">--</div>
                                            <small class="text-muted">압박 레벨</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="h4 text-info mb-1" id="balance-trend">--</div>
                                            <small class="text-muted">밸런스 동향</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 고급 컨트롤 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tools me-2"></i>고급 컨트롤
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-3">
                        <button class="btn btn-outline-info w-100" onclick="simulateTime(1)">
                            <i class="fas fa-forward me-1"></i>1시간 경과
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-warning w-100" onclick="getAvailableItems()">
                            <i class="fas fa-box me-1"></i>아이템 목록
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-success w-100" onclick="refreshSystemStatus()">
                            <i class="fas fa-sync me-1"></i>상태 새로고침
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary w-100" onclick="resetSimulator()">
                            <i class="fas fa-undo me-1"></i>시뮬레이터 리셋
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 성대모드 전용 JavaScript
let sungdaeOrders = [];
let currentInventory = [];
let inventoryFilter = 'all';

// 초기화
document.addEventListener('DOMContentLoaded', function() {
    // 레벨 슬라이더 이벤트
    document.getElementById('sungdae-player-level').addEventListener('input', function() {
        document.getElementById('sungdae-level-display').textContent = this.value;
        // 레벨 변경 시 인벤토리도 업데이트 (레벨에 따라 아이템 변경 가능)
        refreshInventory();
    });

    // 스트러글 스코어 슬라이더 이벤트
    document.getElementById('sungdae-struggle-score').addEventListener('input', function() {
        document.getElementById('struggle-display').textContent = this.value;
    });

    // 수동 스트러글 스코어 토글
    document.getElementById('manual-struggle').addEventListener('change', function() {
        const slider = document.getElementById('sungdae-struggle-score');
        slider.disabled = !this.checked;
        
        if (this.checked) {
            // 수동 설정으로 스트러글 스코어 적용
            adjustStruggleScore(slider.value);
        }
    });

    // 초기 시스템 상태 로드
    refreshSystemStatus();
    
    // 초기 인벤토리 로드
    refreshInventory();
});

// 단일 주문 생성
function generateSungdaeOrder() {
    const playerLevel = document.getElementById('sungdae-player-level').value;
    const deliveryType = document.getElementById('sungdae-delivery-type').value;
    const manualStruggle = document.getElementById('manual-struggle').checked;
    const struggleScore = manualStruggle ? document.getElementById('sungdae-struggle-score').value : null;

    const data = {
        player_level: parseInt(playerLevel),
        delivery_type: deliveryType,
        struggle_score: struggleScore ? parseFloat(struggleScore) : null,
        use_struggle_adjustment: true
    };

    fetch('/api/sungdae/generate-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addOrderToDisplay(data.order);
            updateSystemStatus(data.system_status);
        } else {
            alert('주문 생성 실패: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('API 요청 실패: ' + error);
    });
}

// 배치 주문 생성
function generateBatchOrders() {
    const deliveryType = document.getElementById('sungdae-delivery-type').value;
    const playerLevel = document.getElementById('sungdae-player-level').value;
    const struggleScore = document.getElementById('sungdae-struggle-score').value;
    const useStruggleAdjustment = document.getElementById('use-struggle-adjustment').checked;
    
    const data = {
        count: 5,
        delivery_types: [deliveryType],
        player_level: parseInt(playerLevel),
        struggle_score: parseFloat(struggleScore),
        use_struggle_adjustment: useStruggleAdjustment
    };

    fetch('/api/sungdae/batch-orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 배치 주문을 역순으로 추가해서 최신이 위에 오도록 함
            data.orders.reverse().forEach(order => addOrderToDisplay(order));
            updateSystemStatus(data.system_status);
        } else {
            alert('배치 생성 실패: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('API 요청 실패: ' + error);
    });
}

// 주문을 화면에 추가
function addOrderToDisplay(order) {
    // 최신 주문을 앞에 추가 (unshift 사용)
    sungdaeOrders.unshift(order);
    renderOrders();
    
    // 인벤토리 업데이트 (주문 생성 시 재고 소모 시뮬레이션)
    refreshInventory();
    
    // 다이나믹 밸런싱 데이터도 업데이트
    if (order.dynamic_balancing_data) {
        updateDynamicBalancingDisplay(order.dynamic_balancing_data);
    }
}

// 주문 목록 렌더링
function renderOrders() {
    const container = document.getElementById('sungdae-orders-container');
    
    if (sungdaeOrders.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-truck fa-2x mb-2"></i>
                <p>아직 생성된 주문이 없습니다.</p>
                <p class="small">위의 설정을 조정하고 주문을 생성해보세요.</p>
            </div>
        `;
        return;
    }

    const ordersHtml = sungdaeOrders.map((order, index) => {
        const difficultyColor = {
            '쉬움': 'success',
            '보통': 'primary', 
            '어려움': 'warning',
            '매우어려움': 'danger'
        }[order.difficulty] || 'secondary';

        const deliveryIcon = order.delivery_type === 'Train' ? 'fas fa-train' : 'fas fa-truck';
        const deliveryColor = order.delivery_type === 'Train' ? 'info' : 'primary';

        const itemsHtml = Object.entries(order.items).map(([item, quantity]) => 
            `<span class="badge bg-light text-dark me-1">${item}: ${quantity}</span>`
        ).join('');

        // Township 기차 메타데이터 표시
        let townshipInfo = '';
        if (order.delivery_type === 'Train' && order.generation_metadata) {
            const metadata = order.generation_metadata;
            let trainDetails = [];
            
            // 기차칸 정보
            if (metadata.township_train_cars) {
                trainDetails.push(`${metadata.township_train_cars}칸`);
            }
            
            // 칸 분배 정보
            if (metadata.car_distribution) {
                const carDist = metadata.car_distribution;
                if (carDist.estimated_cars_needed) {
                    trainDetails.push(`예상 ${carDist.estimated_cars_needed}칸 사용`);
                }
                if (carDist.car_efficiency) {
                    trainDetails.push(`효율 ${carDist.car_efficiency.toFixed(1)}`);
                }
            }
            
            // 아이템별 칸 정보 (실제 Township 스타일)
            const itemDetails = Object.entries(order.items).map(([item, qty], index) => 
                `${index + 1}칸: ${item} ${qty}개`
            ).join(', ');
            
            if (trainDetails.length > 0 || itemDetails) {
                townshipInfo = `
                    <div class="mt-2 p-2 bg-info bg-opacity-10 rounded">
                        <small class="text-info">
                            <i class="fas fa-train me-1"></i>Township 기차: ${trainDetails.join(', ')}
                            ${itemDetails ? `<br><span class="ms-3">${itemDetails}</span>` : ''}
                        </small>
                    </div>
                `;
            }
        }

        return `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-0">
                            <i class="${deliveryIcon} text-${deliveryColor} me-2"></i>주문 #${order.id}
                        </h6>
                        <div>
                            <span class="badge bg-${difficultyColor}">${order.difficulty}</span>
                            <span class="badge bg-${deliveryColor} ms-1">${order.delivery_type}</span>
                        </div>
                    </div>
                    <p class="card-text mb-2">${itemsHtml}</p>
                    <div class="row text-muted small">
                        <div class="col-md-4">
                            <i class="fas fa-coins me-1"></i>가치: ${order.total_value}
                        </div>
                        <div class="col-md-4">
                            <i class="fas fa-chart-line me-1"></i>스트러글: ${order.struggle_score.toFixed(1)}
                        </div>
                        <div class="col-md-4">
                            <i class="fas fa-clock me-1"></i>총 생산시간: ${formatProductionTime(order.total_production_time || 0)}
                        </div>
                    </div>
                    ${townshipInfo}
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = ordersHtml;
}

// 시스템 상태 업데이트
function updateSystemStatus(status) {
    const container = document.getElementById('sungdae-system-status');
    
    const healthColor = status.resource_health.deficit > status.resource_health.healthy ? 'danger' : 'success';
    
    container.innerHTML = `
        <div class="row g-1">
            <div class="col-6">
                <div class="text-center">
                    <div class="fs-6 fw-bold">${status.current_struggle_score.toFixed(1)}</div>
                    <small class="text-muted" style="font-size: 0.7rem">스트러글</small>
                </div>
            </div>
            <div class="col-6">
                <div class="text-center">
                    <div class="fs-6 fw-bold">${status.total_orders_generated}</div>
                    <small class="text-muted" style="font-size: 0.7rem">총 주문</small>
                </div>
            </div>
            <div class="col-6">
                <div class="text-center">
                    <div class="fs-6 fw-bold text-${healthColor}">${status.deficit_items_count}</div>
                    <small class="text-muted" style="font-size: 0.7rem">부족</small>
                </div>
            </div>
            <div class="col-6">
                <div class="text-center">
                    <div class="fs-6 fw-bold">${status.average_struggle_score.toFixed(1)}</div>
                    <small class="text-muted" style="font-size: 0.7rem">평균</small>
                </div>
            </div>
        </div>
    `;
    
    // 다이나믹 밸런싱 데이터가 있으면 업데이트
    if (status.dynamic_balancing_data) {
        updateDynamicBalancingDisplay(status.dynamic_balancing_data);
    }
}

// 다이나믹 밸런싱 디스플레이 업데이트
function updateDynamicBalancingDisplay(data) {
    if (!data || !data.balancing_metrics) return;
    
    const metrics = data.balancing_metrics;
    
    // 압력 지수 업데이트
    if (metrics.pressure_index !== undefined) {
        document.getElementById('pressure-index').textContent = metrics.pressure_index.toFixed(1);
        const pressureBar = document.getElementById('pressure-bar');
        pressureBar.style.width = `${Math.min(100, metrics.pressure_index)}%`;
        pressureBar.className = `progress-bar ${metrics.pressure_index > 70 ? 'bg-danger' : metrics.pressure_index > 40 ? 'bg-warning' : 'bg-success'}`;
    }
    
    // 희소성 지수 업데이트
    if (metrics.scarcity_index !== undefined) {
        document.getElementById('scarcity-index').textContent = metrics.scarcity_index.toFixed(1);
        document.getElementById('scarcity-bar').style.width = `${Math.min(100, metrics.scarcity_index)}%`;
    }
    
    // 다양성 점수 업데이트
    if (metrics.diversity_score !== undefined) {
        document.getElementById('diversity-score').textContent = metrics.diversity_score.toFixed(1);
        document.getElementById('diversity-bar').style.width = `${Math.min(100, metrics.diversity_score)}%`;
    }
    
    // 효율성 등급 업데이트
    if (metrics.efficiency_rating !== undefined) {
        document.getElementById('efficiency-rating').textContent = metrics.efficiency_rating.toFixed(1);
        document.getElementById('efficiency-bar').style.width = `${Math.min(100, metrics.efficiency_rating)}%`;
    }
    
    // 새로운 밸런싱 시각화 업데이트
    updateAdvancedBalancingVisuals(data);
}

// 고급 밸런싱 시각화 업데이트
function updateAdvancedBalancingVisuals(data) {
    // 소스 태깅 분석 업데이트
    updateSourceTaggingInfo(data.source_tagging_analysis || {});
    
    // 생산 압박 분석 업데이트  
    updateProductionPressureInfo(data.production_pressure_analysis || {});
    
    // 패턴 선정 분석 업데이트
    updatePatternSelectionInfo(data.pattern_selection_analysis || {});
    
    // 실시간 밸런싱 상태 업데이트
    updateRealTimeBalanceInfo(data);
}

// 소스 태깅 분석 정보 업데이트
function updateSourceTaggingInfo(sourceData) {
    const container = document.getElementById('source-tagging-info');
    
    if (!sourceData.resources || Object.keys(sourceData.resources).length === 0) {
        container.innerHTML = '<small class="text-muted">데이터 없음</small>';
        return;
    }
    
    let html = '<div class="small">';
    
    // 상위 5개 자원의 소스 태깅 정보
    const topResources = Object.entries(sourceData.resources).slice(0, 5);
    
    topResources.forEach(([itemName, tags]) => {
        const primarySource = tags.primary_source || 'unknown';
        const sourceIcon = {
            'STORAGE': 'fa-warehouse',
            'SHELF': 'fa-store',
            'MARKET': 'fa-shopping-cart',
            'PRODUCTION': 'fa-cogs'
        }[primarySource] || 'fa-question';
        
        const confidenceColor = tags.confidence > 0.8 ? 'success' : tags.confidence > 0.5 ? 'warning' : 'danger';
        
        html += `
            <div class="d-flex justify-content-between align-items-center mb-2 py-1 border-bottom">
                <div class="d-flex align-items-center">
                    <i class="fas ${sourceIcon} text-primary me-2"></i>
                    <span class="fw-bold">${itemName}</span>
                </div>
                <span class="badge bg-${confidenceColor}">${(tags.confidence * 100).toFixed(0)}%</span>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// 생산 압박 분석 정보 업데이트
function updateProductionPressureInfo(pressureData) {
    const container = document.getElementById('production-pressure-info');
    
    if (!pressureData.building_pressures) {
        container.innerHTML = '<small class="text-muted">데이터 없음</small>';
        return;
    }
    
    let html = '<div class="small">';
    
    const overallPressure = pressureData.overall_pressure || 0;
    const pressureColor = overallPressure > 0.8 ? 'danger' : overallPressure > 0.5 ? 'warning' : 'success';
    
    html += `
        <div class="text-center mb-3">
            <div class="h5 text-${pressureColor} mb-1">${(overallPressure * 100).toFixed(0)}%</div>
            <small class="text-muted">전체 압박도</small>
        </div>
    `;
    
    // 상위 압박 건물들
    const highPressureBuildings = pressureData.high_pressure_buildings || [];
    if (highPressureBuildings.length > 0) {
        html += '<div class="mb-2"><strong>고압박 건물:</strong></div>';
        highPressureBuildings.slice(0, 3).forEach(building => {
            html += `
                <div class="d-flex justify-content-between mb-1">
                    <span>${building.name}</span>
                    <span class="text-danger">${(building.pressure * 100).toFixed(0)}%</span>
                </div>
            `;
        });
    }
    
    html += '</div>';
    container.innerHTML = html;
}

// 패턴 선정 분석 정보 업데이트
function updatePatternSelectionInfo(patternData) {
    const container = document.getElementById('pattern-selection-info');
    
    if (!patternData.selected_pattern) {
        container.innerHTML = '<small class="text-muted">데이터 없음</small>';
        return;
    }
    
    const pattern = patternData.selected_pattern;
    const candidates = patternData.pattern_candidates || [];
    
    let html = '<div class="small">';
    
    // 선택된 패턴 정보
    html += `
        <div class="text-center mb-3">
            <div class="badge bg-primary fs-6 mb-2">${pattern.name || pattern.id}</div>
            <div class="text-muted small">선택된 패턴</div>
        </div>
    `;
    
    // 후보 패턴들
    if (candidates.length > 1) {
        html += '<div class="mb-2"><strong>후보 패턴:</strong></div>';
        candidates.slice(0, 3).forEach(candidate => {
            const isSelected = candidate.id === pattern.id;
            const badgeColor = isSelected ? 'success' : 'secondary';
            
            html += `
                <div class="d-flex justify-content-between mb-1">
                    <span class="badge bg-${badgeColor} me-2">${candidate.name}</span>
                    <span class="small">${(candidate.weight * 100).toFixed(0)}%</span>
                </div>
            `;
        });
    }
    
    html += '</div>';
    container.innerHTML = html;
}

// 실시간 밸런싱 상태 정보 업데이트  
function updateRealTimeBalanceInfo(data) {
    // 스트러글 스코어
    const struggleScore = data.current_struggle_score || 0;
    document.getElementById('struggle-score').textContent = struggleScore.toFixed(1);
    
    // 부족 비율
    const deficitRatio = data.resource_deficit_ratio || 0;
    document.getElementById('deficit-ratio').textContent = (deficitRatio * 100).toFixed(0) + '%';
    
    // 압박 레벨
    const pressureLevel = data.production_pressure_analysis?.overall_pressure || 0;
    document.getElementById('pressure-level').textContent = (pressureLevel * 100).toFixed(0) + '%';
    
    // 밸런스 동향
    const trend = data.struggle_trend || 'stable';
    const trendText = {
        'increasing': '상승',
        'decreasing': '하락', 
        'stable': '안정',
        'insufficient_data': '분석중'
    }[trend] || '분석중';
    document.getElementById('balance-trend').textContent = trendText;
}

// 스트러글 스코어 조정
function adjustStruggleScore(newScore) {
    fetch('/api/sungdae/adjust-struggle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ struggle_score: parseFloat(newScore) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateSystemStatus(data.system_status);
        } else {
            alert('스트러글 스코어 조정 실패: ' + data.error);
        }
    })
    .catch(error => console.error('Error:', error));
}

// 시간 시뮬레이션
function simulateTime(hours) {
    fetch('/api/sungdae/simulate-time', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ hours: hours })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateSystemStatus(data.system_status);
            alert(data.message);
        } else {
            alert('시간 시뮬레이션 실패: ' + data.error);
        }
    })
    .catch(error => console.error('Error:', error));
}

// 사용 가능한 아이템 목록
function getAvailableItems() {
    fetch('/api/sungdae/available-items')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const itemsInfo = data.items.map(item => 
                `${item.name} (${item.layer}, 재고: ${item.current_stock}/${item.max_capacity})`
            ).join('\n');
            
            alert(`총 ${data.total_count}개 아이템:\n\n${itemsInfo.substring(0, 1000)}${data.items.length > 20 ? '\n...' : ''}`);
        } else {
            alert('아이템 목록 조회 실패: ' + data.error);
        }
    })
    .catch(error => console.error('Error:', error));
}

// 시스템 상태 새로고침
function refreshSystemStatus() {
    fetch('/api/sungdae/stats')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateSystemStatus(data.status);
        } else {
            console.error('시스템 상태 조회 실패:', data.error);
        }
    })
    .catch(error => console.error('Error:', error));
}

// 주문 목록 비우기
function clearSungdaeOrders() {
    if (confirm('모든 주문을 삭제하시겠습니까?')) {
        sungdaeOrders = [];
        renderOrders();
    }
}

// 시뮬레이터 리셋 (실제로는 페이지 새로고침)
function resetSimulator() {
    if (confirm('시뮬레이터를 리셋하시겠습니까?')) {
        location.reload();
    }
}

// 인벤토리 새로고침
function refreshInventory() {
    fetch('/api/sungdae/available-items')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentInventory = data.items;
            renderInventory();
            
            // 디버그 정보 표시
            if (data.debug_info) {
                console.log('플레이어 레벨:', data.debug_info.player_level);
                console.log('Barn 용량:', data.debug_info.barn_capacity);
                console.log('전체 DB 아이템:', data.debug_info.total_items_in_db);
                console.log('언락된 아이템:', data.debug_info.unlocked_items);
                console.log('레벨별 아이템 수:', data.debug_info.level_breakdown);
                
                // Barn 용량 표시 업데이트
                updateBarnCapacityDisplay(data.debug_info.barn_capacity);
            }
        } else {
            console.error('인벤토리 조회 실패:', data.error);
        }
    })
    .catch(error => console.error('Error:', error));
}

// 인벤토리 렌더링
function renderInventory() {
    const container = document.getElementById('inventory-container');
    
    if (!currentInventory || currentInventory.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="fas fa-box-open fa-2x mb-2"></i>
                <p>인벤토리 데이터가 없습니다.</p>
            </div>
        `;
        return;
    }
    
    // 필터링 적용
    let filteredInventory = currentInventory;
    if (inventoryFilter === 'deficit') {
        filteredInventory = currentInventory.filter(item => item.is_deficit);
    } else if (inventoryFilter === 'abundant') {
        filteredInventory = currentInventory.filter(item => item.stock_ratio > 0.8);
    }
    
    // 레이어별로 그룹핑
    const groupedByLayer = {
        'CROPS': filteredInventory.filter(item => item.layer === 'CROPS'),
        'MID': filteredInventory.filter(item => item.layer === 'MID'),
        'TOP': filteredInventory.filter(item => item.layer === 'TOP')
    };
    
    let inventoryHtml = '';
    
    Object.entries(groupedByLayer).forEach(([layer, items]) => {
        if (items.length === 0) return;
        
        const layerNames = {
            'CROPS': '🌾 기본 작물/동물',
            'MID': '⚙️ 중급 가공품',
            'TOP': '💎 고급 제품'
        };
        
        inventoryHtml += `
            <div class="mb-4">
                <h6 class="text-muted mb-3">${layerNames[layer]} (${items.length}개)</h6>
                <div class="row g-2">
        `;
        
        items.slice(0, 20).forEach(item => { // 최대 20개까지만 표시
            const stockPercentage = Math.min(100, item.stock_ratio * 100);
            const stockColor = item.is_deficit ? 'danger' : stockPercentage > 80 ? 'success' : stockPercentage > 40 ? 'warning' : 'danger';
            const stockIcon = item.is_deficit ? 'fa-exclamation-triangle' : stockPercentage > 80 ? 'fa-check-circle' : 'fa-clock';
            
            inventoryHtml += `
                <div class="col-md-3 col-sm-4 col-6">
                    <div class="card border-${stockColor === 'danger' ? 'danger' : 'light'} h-100">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <small class="fw-bold text-truncate" style="font-size: 0.75rem">${item.name}</small>
                                <i class="fas ${stockIcon} text-${stockColor}" style="font-size: 0.7rem"></i>
                            </div>
                            <div class="progress mb-1" style="height: 4px;">
                                <div class="progress-bar bg-${stockColor}" style="width: ${stockPercentage}%"></div>
                            </div>
                            <div class="d-flex justify-content-between" style="font-size: 0.65rem;">
                                <span class="text-muted">${item.current_stock}/${item.max_capacity}</span>
                                <span class="text-${stockColor}">${stockPercentage.toFixed(0)}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        if (items.length > 20) {
            inventoryHtml += `
                <div class="col-12">
                    <small class="text-muted">...그 외 ${items.length - 20}개 아이템</small>
                </div>
            `;
        }
        
        inventoryHtml += `
                </div>
            </div>
        `;
    });
    
    container.innerHTML = inventoryHtml;
}

// 인벤토리 필터링
function filterInventory(filter) {
    inventoryFilter = filter;
    renderInventory();
    
    // 버튼 텍스트 업데이트
    const filterNames = {
        'all': '전체 보기',
        'deficit': '부족 아이템만',
        'abundant': '풍부한 아이템만'
    };
    
    // 드롭다운 버튼 텍스트 업데이트는 생략 (복잡함)
}

// 인벤토리 편집 모달 열기
function openInventoryEditor() {
    if (!currentInventory || currentInventory.length === 0) {
        showToast('인벤토리 데이터를 먼저 로드해주세요.', 'error');
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('inventoryEditModal'));
    renderInventoryEditor();
    modal.show();
}

// 인벤토리 편집 화면 렌더링
function renderInventoryEditor() {
    const container = document.getElementById('inventory-editor-container');
    
    let editorHtml = '';
    currentInventory.forEach((item, index) => {
        editorHtml += `
            <div class="row mb-2 align-items-center">
                <div class="col-md-4">
                    <small class="fw-bold">${item.name}</small>
                    <br><small class="text-muted">${item.layer} | 언락 Lv.${item.unlock_level}</small>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control form-control-sm" 
                           id="stock-${index}" 
                           value="${item.current_stock}" 
                           min="0" max="9999"
                           data-item="${item.name}">
                </div>
                <div class="col-md-2">
                    <small class="text-muted">/ ${item.max_capacity}</small>
                </div>
                <div class="col-md-3">
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="adjustStock('${index}', -10)">
                            -10
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="adjustStock('${index}', -1)">
                            -1
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="adjustStock('${index}', 1)">
                            +1
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="adjustStock('${index}', 10)">
                            +10
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = editorHtml;
}

// 재고 수량 조정
function adjustStock(index, delta) {
    const input = document.getElementById(`stock-${index}`);
    const currentValue = parseInt(input.value) || 0;
    const newValue = Math.max(0, Math.min(9999, currentValue + delta));
    input.value = newValue;
}

// 인벤토리 업데이트 적용
function applyInventoryChanges() {
    const updates = {};
    let hasChanges = false;
    
    currentInventory.forEach((item, index) => {
        const input = document.getElementById(`stock-${index}`);
        const newValue = parseInt(input.value) || 0;
        if (newValue !== item.current_stock) {
            updates[item.name] = newValue;
            hasChanges = true;
        }
    });
    
    if (!hasChanges) {
        showToast('변경된 항목이 없습니다.', 'info');
        return;
    }
    
    fetch('/api/sungdae/inventory/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ updates: updates })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            // 모달 닫기
            bootstrap.Modal.getInstance(document.getElementById('inventoryEditModal')).hide();
            // 인벤토리 새로고침
            refreshInventory();
        } else {
            showToast('인벤토리 업데이트 실패: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('API 요청 실패: ' + error, 'error');
    });
}

// 인벤토리 초기화
function resetInventory() {
    if (!confirm('정말로 인벤토리를 초기 상태로 재설정하시겠습니까?')) {
        return;
    }
    
    fetch('/api/sungdae/inventory/reset', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            refreshInventory();
        } else {
            showToast('인벤토리 초기화 실패: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('API 요청 실패: ' + error, 'error');
    });
}

// Barn 용량 표시 업데이트
function updateBarnCapacityDisplay(barnCapacity) {
    if (!currentInventory || !barnCapacity) return;
    
    // 현재 총 보관량 계산 (모든 아이템 합계)
    const totalUsed = currentInventory.reduce((sum, item) => sum + item.current_stock, 0);
    
    // Barn 용량 정보 업데이트
    document.getElementById('barn-capacity-info').innerHTML = 
        `Barn: <span class="${totalUsed > barnCapacity * 0.9 ? 'text-warning' : 'text-light'}">${totalUsed}</span>/${barnCapacity}`;
}
</script>

<!-- 인벤토리 편집 모달 -->
<div class="modal fade" id="inventoryEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>인벤토리 편집
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4"><strong>아이템</strong></div>
                    <div class="col-md-3"><strong>현재 수량</strong></div>
                    <div class="col-md-2"><strong>최대</strong></div>
                    <div class="col-md-3"><strong>조정</strong></div>
                </div>
                <div id="inventory-editor-container" style="max-height: 400px; overflow-y: auto;">
                    <!-- 동적으로 생성됨 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="applyInventoryChanges()">
                    <i class="fas fa-save me-1"></i>적용
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}