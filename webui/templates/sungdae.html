{% extends "base.html" %}

{% block title %}ì„±ëŒ€ëª¨ë“œ - Township ë‹¤ì´ë‚˜ë¯¹ ë°¸ëŸ°ì‹±{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="display-6 fw-bold text-primary mb-4">
            <i class="fas fa-train me-2"></i>ì„±ëŒ€ëª¨ë“œ ì‹œë®¬ë ˆì´í„°
            <span class="badge bg-success ms-2">Township v2.1</span>
        </h1>
        <p class="lead text-muted mb-4">ë‹¤ì´ë‚˜ë¯¹ ë°¸ëŸ°ì‹± ì‹œìŠ¤í…œ</p>
    </div>
</div>

<div class="row">
    <!-- ì‹œë®¬ë ˆì´í„° ì»¨íŠ¸ë¡¤ -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cog me-2"></i>ì„±ëŒ€ëª¨ë“œ ì„¤ì •
                </h5>
            </div>
            <div class="card-body">
                <!-- í”Œë ˆì´ì–´ ë ˆë²¨ -->
                <div class="mb-3">
                    <label class="form-label">í”Œë ˆì´ì–´ ë ˆë²¨</label>
                    <input type="range" class="form-range" id="sungdae-player-level" min="1" max="100" value="5">
                    <div class="d-flex justify-content-between">
                        <small>1</small>
                        <small id="sungdae-level-display">5</small>
                        <small>100</small>
                    </div>
                </div>

                <!-- ë‚©í’ˆ íƒ€ì… ì„ íƒ -->
                <div class="mb-3">
                    <label class="form-label">ë‚©í’ˆ íƒ€ì…</label>
                    <select class="form-select" id="sungdae-delivery-type">
                        <option value="Truck">ğŸšš íŠ¸ëŸ­ ë‚©í’ˆ</option>
                        <option value="Train">ğŸš‚ ê¸°ì°¨ ë‚©í’ˆ</option>
                    </select>
                </div>

                <!-- ìŠ¤íŠ¸ëŸ¬ê¸€ ìŠ¤ì½”ì–´ ìˆ˜ë™ ì„¤ì • -->
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <label class="form-label mb-0 me-2">ìŠ¤íŠ¸ëŸ¬ê¸€ ìŠ¤ì½”ì–´</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="manual-struggle">
                            <label class="form-check-label" for="manual-struggle">ìˆ˜ë™</label>
                        </div>
                    </div>
                    <input type="range" class="form-range" id="sungdae-struggle-score" min="0" max="100" value="50" disabled>
                    <div class="d-flex justify-content-between">
                        <small>ì‰¬ì›€ (0)</small>
                        <small id="struggle-display">50</small>
                        <small>ì–´ë ¤ì›€ (100)</small>
                    </div>
                </div>

                <!-- ìƒì„± ë²„íŠ¼ë“¤ -->
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="generateSungdaeOrder()">
                        <i class="fas fa-plus me-2"></i>ë‹¨ì¼ ì£¼ë¬¸ ìƒì„±
                    </button>
                    <button class="btn btn-outline-primary" onclick="generateBatchOrders()">
                        <i class="fas fa-layer-group me-2"></i>ë°°ì¹˜ ìƒì„± (5ê°œ)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ë‹¤ì´ë‚˜ë¯¹ ë°¸ëŸ°ì‹± ìƒíƒœ -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-balance-scale me-2"></i>ë‹¤ì´ë‚˜ë¯¹ ë°¸ëŸ°ì‹±
                </h5>
            </div>
            <div class="card-body">
                <div id="dynamic-balancing-status">
                    <!-- ë°¸ëŸ°ì‹± ì§€í‘œ -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>ì••ë ¥ ì§€ìˆ˜</small>
                            <small id="pressure-index">-</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="pressure-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>í¬ì†Œì„± ì§€ìˆ˜</small>
                            <small id="scarcity-index">-</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="scarcity-bar" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>ë‹¤ì–‘ì„± ì ìˆ˜</small>
                            <small id="diversity-score">-</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="diversity-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>íš¨ìœ¨ì„± ë“±ê¸‰</small>
                            <small id="efficiency-rating">-</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="efficiency-bar" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- ì‹œìŠ¤í…œ ìƒíƒœ ìš”ì•½ -->
                    <div id="sungdae-system-status" class="mt-3 p-2 bg-light rounded">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p class="mb-0 small">ì´ˆê¸°í™” ì¤‘...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- ì¸ë²¤í† ë¦¬ ìƒíƒœ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-boxes me-2"></i>í˜„ì¬ ì¸ë²¤í† ë¦¬
                </h5>
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-outline-info" onclick="refreshInventory()">
                        <i class="fas fa-sync me-1"></i>ìƒˆë¡œê³ ì¹¨
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="openInventoryEditor()">
                        <i class="fas fa-edit me-1"></i>ì¬ê³  í¸ì§‘
                    </button>
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-filter me-1"></i>í•„í„°
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="filterInventory('all')">ì „ì²´ ë³´ê¸°</a></li>
                        <li><a class="dropdown-item" href="#" onclick="filterInventory('deficit')">ë¶€ì¡± ì•„ì´í…œë§Œ</a></li>
                        <li><a class="dropdown-item" href="#" onclick="filterInventory('abundant')">í’ë¶€í•œ ì•„ì´í…œë§Œ</a></li>
                    </ul>
                    <button class="btn btn-sm btn-outline-danger" onclick="resetInventory()">
                        <i class="fas fa-undo me-1"></i>ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="inventory-container">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p class="mb-0">ì¸ë²¤í† ë¦¬ ë¡œë”© ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ìƒì„±ëœ ì£¼ë¬¸ í‘œì‹œ -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>ìƒì„±ëœ ì£¼ë¬¸
                </h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearSungdaeOrders()">
                    <i class="fas fa-trash me-1"></i>ëª¨ë‘ ì‚­ì œ
                </button>
            </div>
            <div class="card-body">
                <div id="sungdae-orders-container">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-truck fa-2x mb-2"></i>
                        <p>ì•„ì§ ìƒì„±ëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p class="small">ìœ„ì˜ ì„¤ì •ì„ ì¡°ì •í•˜ê³  ì£¼ë¬¸ì„ ìƒì„±í•´ë³´ì„¸ìš”.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ê³ ê¸‰ ì»¨íŠ¸ë¡¤ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tools me-2"></i>ê³ ê¸‰ ì»¨íŠ¸ë¡¤
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-3">
                        <button class="btn btn-outline-info w-100" onclick="simulateTime(1)">
                            <i class="fas fa-forward me-1"></i>1ì‹œê°„ ê²½ê³¼
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-warning w-100" onclick="getAvailableItems()">
                            <i class="fas fa-box me-1"></i>ì•„ì´í…œ ëª©ë¡
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-success w-100" onclick="refreshSystemStatus()">
                            <i class="fas fa-sync me-1"></i>ìƒíƒœ ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary w-100" onclick="resetSimulator()">
                            <i class="fas fa-undo me-1"></i>ì‹œë®¬ë ˆì´í„° ë¦¬ì…‹
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ì„±ëŒ€ëª¨ë“œ ì „ìš© JavaScript
let sungdaeOrders = [];
let currentInventory = [];
let inventoryFilter = 'all';

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    // ë ˆë²¨ ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
    document.getElementById('sungdae-player-level').addEventListener('input', function() {
        document.getElementById('sungdae-level-display').textContent = this.value;
        // ë ˆë²¨ ë³€ê²½ ì‹œ ì¸ë²¤í† ë¦¬ë„ ì—…ë°ì´íŠ¸ (ë ˆë²¨ì— ë”°ë¼ ì•„ì´í…œ ë³€ê²½ ê°€ëŠ¥)
        refreshInventory();
    });

    // ìŠ¤íŠ¸ëŸ¬ê¸€ ìŠ¤ì½”ì–´ ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
    document.getElementById('sungdae-struggle-score').addEventListener('input', function() {
        document.getElementById('struggle-display').textContent = this.value;
    });

    // ìˆ˜ë™ ìŠ¤íŠ¸ëŸ¬ê¸€ ìŠ¤ì½”ì–´ í† ê¸€
    document.getElementById('manual-struggle').addEventListener('change', function() {
        const slider = document.getElementById('sungdae-struggle-score');
        slider.disabled = !this.checked;
        
        if (this.checked) {
            // ìˆ˜ë™ ì„¤ì •ìœ¼ë¡œ ìŠ¤íŠ¸ëŸ¬ê¸€ ìŠ¤ì½”ì–´ ì ìš©
            adjustStruggleScore(slider.value);
        }
    });

    // ì´ˆê¸° ì‹œìŠ¤í…œ ìƒíƒœ ë¡œë“œ
    refreshSystemStatus();
    
    // ì´ˆê¸° ì¸ë²¤í† ë¦¬ ë¡œë“œ
    refreshInventory();
});

// ë‹¨ì¼ ì£¼ë¬¸ ìƒì„±
function generateSungdaeOrder() {
    const playerLevel = document.getElementById('sungdae-player-level').value;
    const deliveryType = document.getElementById('sungdae-delivery-type').value;
    const manualStruggle = document.getElementById('manual-struggle').checked;
    const struggleScore = manualStruggle ? document.getElementById('sungdae-struggle-score').value : null;

    const data = {
        player_level: parseInt(playerLevel),
        delivery_type: deliveryType,
        struggle_score: struggleScore ? parseFloat(struggleScore) : null,
        use_struggle_adjustment: true
    };

    fetch('/api/sungdae/generate-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addOrderToDisplay(data.order);
            updateSystemStatus(data.system_status);
        } else {
            alert('ì£¼ë¬¸ ìƒì„± ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('API ìš”ì²­ ì‹¤íŒ¨: ' + error);
    });
}

// ë°°ì¹˜ ì£¼ë¬¸ ìƒì„±
function generateBatchOrders() {
    const deliveryType = document.getElementById('sungdae-delivery-type').value;
    const playerLevel = document.getElementById('sungdae-player-level').value;
    const struggleScore = document.getElementById('sungdae-struggle-score').value;
    const useStruggleAdjustment = document.getElementById('use-struggle-adjustment').checked;
    
    const data = {
        count: 5,
        delivery_types: [deliveryType],
        player_level: parseInt(playerLevel),
        struggle_score: parseFloat(struggleScore),
        use_struggle_adjustment: useStruggleAdjustment
    };

    fetch('/api/sungdae/batch-orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ë°°ì¹˜ ì£¼ë¬¸ì„ ì—­ìˆœìœ¼ë¡œ ì¶”ê°€í•´ì„œ ìµœì‹ ì´ ìœ„ì— ì˜¤ë„ë¡ í•¨
            data.orders.reverse().forEach(order => addOrderToDisplay(order));
            updateSystemStatus(data.system_status);
        } else {
            alert('ë°°ì¹˜ ìƒì„± ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('API ìš”ì²­ ì‹¤íŒ¨: ' + error);
    });
}

// ì£¼ë¬¸ì„ í™”ë©´ì— ì¶”ê°€
function addOrderToDisplay(order) {
    // ìµœì‹  ì£¼ë¬¸ì„ ì•ì— ì¶”ê°€ (unshift ì‚¬ìš©)
    sungdaeOrders.unshift(order);
    renderOrders();
    
    // ì¸ë²¤í† ë¦¬ ì—…ë°ì´íŠ¸ (ì£¼ë¬¸ ìƒì„± ì‹œ ì¬ê³  ì†Œëª¨ ì‹œë®¬ë ˆì´ì…˜)
    refreshInventory();
    
    // ë‹¤ì´ë‚˜ë¯¹ ë°¸ëŸ°ì‹± ë°ì´í„°ë„ ì—…ë°ì´íŠ¸
    if (order.dynamic_balancing_data) {
        updateDynamicBalancingDisplay(order.dynamic_balancing_data);
    }
}

// ì£¼ë¬¸ ëª©ë¡ ë Œë”ë§
function renderOrders() {
    const container = document.getElementById('sungdae-orders-container');
    
    if (sungdaeOrders.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-truck fa-2x mb-2"></i>
                <p>ì•„ì§ ìƒì„±ëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                <p class="small">ìœ„ì˜ ì„¤ì •ì„ ì¡°ì •í•˜ê³  ì£¼ë¬¸ì„ ìƒì„±í•´ë³´ì„¸ìš”.</p>
            </div>
        `;
        return;
    }

    const ordersHtml = sungdaeOrders.map((order, index) => {
        const difficultyColor = {
            'ì‰¬ì›€': 'success',
            'ë³´í†µ': 'primary', 
            'ì–´ë ¤ì›€': 'warning',
            'ë§¤ìš°ì–´ë ¤ì›€': 'danger'
        }[order.difficulty] || 'secondary';

        const deliveryIcon = order.delivery_type === 'Train' ? 'fas fa-train' : 'fas fa-truck';
        const deliveryColor = order.delivery_type === 'Train' ? 'info' : 'primary';

        const itemsHtml = Object.entries(order.items).map(([item, quantity]) => 
            `<span class="badge bg-light text-dark me-1">${item}: ${quantity}</span>`
        ).join('');

        // Township ê¸°ì°¨ ë©”íƒ€ë°ì´í„° í‘œì‹œ
        let townshipInfo = '';
        if (order.delivery_type === 'Train' && order.generation_metadata) {
            const metadata = order.generation_metadata;
            let trainDetails = [];
            
            // ê¸°ì°¨ì¹¸ ì •ë³´
            if (metadata.township_train_cars) {
                trainDetails.push(`${metadata.township_train_cars}ì¹¸`);
            }
            
            // ì¹¸ ë¶„ë°° ì •ë³´
            if (metadata.car_distribution) {
                const carDist = metadata.car_distribution;
                if (carDist.estimated_cars_needed) {
                    trainDetails.push(`ì˜ˆìƒ ${carDist.estimated_cars_needed}ì¹¸ ì‚¬ìš©`);
                }
                if (carDist.car_efficiency) {
                    trainDetails.push(`íš¨ìœ¨ ${carDist.car_efficiency.toFixed(1)}`);
                }
            }
            
            // ì•„ì´í…œë³„ ì¹¸ ì •ë³´ (ì‹¤ì œ Township ìŠ¤íƒ€ì¼)
            const itemDetails = Object.entries(order.items).map(([item, qty], index) => 
                `${index + 1}ì¹¸: ${item} ${qty}ê°œ`
            ).join(', ');
            
            if (trainDetails.length > 0 || itemDetails) {
                townshipInfo = `
                    <div class="mt-2 p-2 bg-info bg-opacity-10 rounded">
                        <small class="text-info">
                            <i class="fas fa-train me-1"></i>Township ê¸°ì°¨: ${trainDetails.join(', ')}
                            ${itemDetails ? `<br><span class="ms-3">${itemDetails}</span>` : ''}
                        </small>
                    </div>
                `;
            }
        }

        return `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-0">
                            <i class="${deliveryIcon} text-${deliveryColor} me-2"></i>ì£¼ë¬¸ #${order.id}
                        </h6>
                        <div>
                            <span class="badge bg-${difficultyColor}">${order.difficulty}</span>
                            <span class="badge bg-${deliveryColor} ms-1">${order.delivery_type}</span>
                        </div>
                    </div>
                    <p class="card-text mb-2">${itemsHtml}</p>
                    <div class="row text-muted small">
                        <div class="col-md-4">
                            <i class="fas fa-coins me-1"></i>ê°€ì¹˜: ${order.total_value}
                        </div>
                        <div class="col-md-4">
                            <i class="fas fa-chart-line me-1"></i>ìŠ¤íŠ¸ëŸ¬ê¸€: ${order.struggle_score.toFixed(1)}
                        </div>
                        <div class="col-md-4">
                            <i class="fas fa-clock me-1"></i>ì´ ìƒì‚°ì‹œê°„: ${Math.ceil((order.total_production_time || 0) / 60)}ë¶„
                        </div>
                    </div>
                    ${townshipInfo}
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = ordersHtml;
}

// ì‹œìŠ¤í…œ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateSystemStatus(status) {
    const container = document.getElementById('sungdae-system-status');
    
    const healthColor = status.resource_health.deficit > status.resource_health.healthy ? 'danger' : 'success';
    
    container.innerHTML = `
        <div class="row g-1">
            <div class="col-6">
                <div class="text-center">
                    <div class="fs-6 fw-bold">${status.current_struggle_score.toFixed(1)}</div>
                    <small class="text-muted" style="font-size: 0.7rem">ìŠ¤íŠ¸ëŸ¬ê¸€</small>
                </div>
            </div>
            <div class="col-6">
                <div class="text-center">
                    <div class="fs-6 fw-bold">${status.total_orders_generated}</div>
                    <small class="text-muted" style="font-size: 0.7rem">ì´ ì£¼ë¬¸</small>
                </div>
            </div>
            <div class="col-6">
                <div class="text-center">
                    <div class="fs-6 fw-bold text-${healthColor}">${status.deficit_items_count}</div>
                    <small class="text-muted" style="font-size: 0.7rem">ë¶€ì¡±</small>
                </div>
            </div>
            <div class="col-6">
                <div class="text-center">
                    <div class="fs-6 fw-bold">${status.average_struggle_score.toFixed(1)}</div>
                    <small class="text-muted" style="font-size: 0.7rem">í‰ê· </small>
                </div>
            </div>
        </div>
    `;
    
    // ë‹¤ì´ë‚˜ë¯¹ ë°¸ëŸ°ì‹± ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
    if (status.dynamic_balancing_data) {
        updateDynamicBalancingDisplay(status.dynamic_balancing_data);
    }
}

// ë‹¤ì´ë‚˜ë¯¹ ë°¸ëŸ°ì‹± ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
function updateDynamicBalancingDisplay(data) {
    if (!data || !data.balancing_metrics) return;
    
    const metrics = data.balancing_metrics;
    
    // ì••ë ¥ ì§€ìˆ˜ ì—…ë°ì´íŠ¸
    if (metrics.pressure_index !== undefined) {
        document.getElementById('pressure-index').textContent = metrics.pressure_index.toFixed(1);
        const pressureBar = document.getElementById('pressure-bar');
        pressureBar.style.width = `${Math.min(100, metrics.pressure_index)}%`;
        pressureBar.className = `progress-bar ${metrics.pressure_index > 70 ? 'bg-danger' : metrics.pressure_index > 40 ? 'bg-warning' : 'bg-success'}`;
    }
    
    // í¬ì†Œì„± ì§€ìˆ˜ ì—…ë°ì´íŠ¸
    if (metrics.scarcity_index !== undefined) {
        document.getElementById('scarcity-index').textContent = metrics.scarcity_index.toFixed(1);
        document.getElementById('scarcity-bar').style.width = `${Math.min(100, metrics.scarcity_index)}%`;
    }
    
    // ë‹¤ì–‘ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸
    if (metrics.diversity_score !== undefined) {
        document.getElementById('diversity-score').textContent = metrics.diversity_score.toFixed(1);
        document.getElementById('diversity-bar').style.width = `${Math.min(100, metrics.diversity_score)}%`;
    }
    
    // íš¨ìœ¨ì„± ë“±ê¸‰ ì—…ë°ì´íŠ¸
    if (metrics.efficiency_rating !== undefined) {
        document.getElementById('efficiency-rating').textContent = metrics.efficiency_rating.toFixed(1);
        document.getElementById('efficiency-bar').style.width = `${Math.min(100, metrics.efficiency_rating)}%`;
    }
}

// ìŠ¤íŠ¸ëŸ¬ê¸€ ìŠ¤ì½”ì–´ ì¡°ì •
function adjustStruggleScore(newScore) {
    fetch('/api/sungdae/adjust-struggle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ struggle_score: parseFloat(newScore) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateSystemStatus(data.system_status);
        } else {
            alert('ìŠ¤íŠ¸ëŸ¬ê¸€ ìŠ¤ì½”ì–´ ì¡°ì • ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => console.error('Error:', error));
}

// ì‹œê°„ ì‹œë®¬ë ˆì´ì…˜
function simulateTime(hours) {
    fetch('/api/sungdae/simulate-time', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ hours: hours })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateSystemStatus(data.system_status);
            alert(data.message);
        } else {
            alert('ì‹œê°„ ì‹œë®¬ë ˆì´ì…˜ ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => console.error('Error:', error));
}

// ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´í…œ ëª©ë¡
function getAvailableItems() {
    fetch('/api/sungdae/available-items')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const itemsInfo = data.items.map(item => 
                `${item.name} (${item.layer}, ì¬ê³ : ${item.current_stock}/${item.max_capacity})`
            ).join('\n');
            
            alert(`ì´ ${data.total_count}ê°œ ì•„ì´í…œ:\n\n${itemsInfo.substring(0, 1000)}${data.items.length > 20 ? '\n...' : ''}`);
        } else {
            alert('ì•„ì´í…œ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => console.error('Error:', error));
}

// ì‹œìŠ¤í…œ ìƒíƒœ ìƒˆë¡œê³ ì¹¨
function refreshSystemStatus() {
    fetch('/api/sungdae/stats')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateSystemStatus(data.status);
        } else {
            console.error('ì‹œìŠ¤í…œ ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨:', data.error);
        }
    })
    .catch(error => console.error('Error:', error));
}

// ì£¼ë¬¸ ëª©ë¡ ë¹„ìš°ê¸°
function clearSungdaeOrders() {
    if (confirm('ëª¨ë“  ì£¼ë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        sungdaeOrders = [];
        renderOrders();
    }
}

// ì‹œë®¬ë ˆì´í„° ë¦¬ì…‹ (ì‹¤ì œë¡œëŠ” í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨)
function resetSimulator() {
    if (confirm('ì‹œë®¬ë ˆì´í„°ë¥¼ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        location.reload();
    }
}

// ì¸ë²¤í† ë¦¬ ìƒˆë¡œê³ ì¹¨
function refreshInventory() {
    fetch('/api/sungdae/available-items')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentInventory = data.items;
            renderInventory();
        } else {
            console.error('ì¸ë²¤í† ë¦¬ ì¡°íšŒ ì‹¤íŒ¨:', data.error);
        }
    })
    .catch(error => console.error('Error:', error));
}

// ì¸ë²¤í† ë¦¬ ë Œë”ë§
function renderInventory() {
    const container = document.getElementById('inventory-container');
    
    if (!currentInventory || currentInventory.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="fas fa-box-open fa-2x mb-2"></i>
                <p>ì¸ë²¤í† ë¦¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        `;
        return;
    }
    
    // í•„í„°ë§ ì ìš©
    let filteredInventory = currentInventory;
    if (inventoryFilter === 'deficit') {
        filteredInventory = currentInventory.filter(item => item.is_deficit);
    } else if (inventoryFilter === 'abundant') {
        filteredInventory = currentInventory.filter(item => item.stock_ratio > 0.8);
    }
    
    // ë ˆì´ì–´ë³„ë¡œ ê·¸ë£¹í•‘
    const groupedByLayer = {
        'CROPS': filteredInventory.filter(item => item.layer === 'CROPS'),
        'MID': filteredInventory.filter(item => item.layer === 'MID'),
        'TOP': filteredInventory.filter(item => item.layer === 'TOP')
    };
    
    let inventoryHtml = '';
    
    Object.entries(groupedByLayer).forEach(([layer, items]) => {
        if (items.length === 0) return;
        
        const layerNames = {
            'CROPS': 'ğŸŒ¾ ê¸°ë³¸ ì‘ë¬¼/ë™ë¬¼',
            'MID': 'âš™ï¸ ì¤‘ê¸‰ ê°€ê³µí’ˆ',
            'TOP': 'ğŸ’ ê³ ê¸‰ ì œí’ˆ'
        };
        
        inventoryHtml += `
            <div class="mb-4">
                <h6 class="text-muted mb-3">${layerNames[layer]} (${items.length}ê°œ)</h6>
                <div class="row g-2">
        `;
        
        items.slice(0, 20).forEach(item => { // ìµœëŒ€ 20ê°œê¹Œì§€ë§Œ í‘œì‹œ
            const stockPercentage = Math.min(100, item.stock_ratio * 100);
            const stockColor = item.is_deficit ? 'danger' : stockPercentage > 80 ? 'success' : stockPercentage > 40 ? 'warning' : 'danger';
            const stockIcon = item.is_deficit ? 'fa-exclamation-triangle' : stockPercentage > 80 ? 'fa-check-circle' : 'fa-clock';
            
            inventoryHtml += `
                <div class="col-md-3 col-sm-4 col-6">
                    <div class="card border-${stockColor === 'danger' ? 'danger' : 'light'} h-100">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <small class="fw-bold text-truncate" style="font-size: 0.75rem">${item.name}</small>
                                <i class="fas ${stockIcon} text-${stockColor}" style="font-size: 0.7rem"></i>
                            </div>
                            <div class="progress mb-1" style="height: 4px;">
                                <div class="progress-bar bg-${stockColor}" style="width: ${stockPercentage}%"></div>
                            </div>
                            <div class="d-flex justify-content-between" style="font-size: 0.65rem;">
                                <span class="text-muted">${item.current_stock}/${item.max_capacity}</span>
                                <span class="text-${stockColor}">${stockPercentage.toFixed(0)}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        if (items.length > 20) {
            inventoryHtml += `
                <div class="col-12">
                    <small class="text-muted">...ê·¸ ì™¸ ${items.length - 20}ê°œ ì•„ì´í…œ</small>
                </div>
            `;
        }
        
        inventoryHtml += `
                </div>
            </div>
        `;
    });
    
    container.innerHTML = inventoryHtml;
}

// ì¸ë²¤í† ë¦¬ í•„í„°ë§
function filterInventory(filter) {
    inventoryFilter = filter;
    renderInventory();
    
    // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    const filterNames = {
        'all': 'ì „ì²´ ë³´ê¸°',
        'deficit': 'ë¶€ì¡± ì•„ì´í…œë§Œ',
        'abundant': 'í’ë¶€í•œ ì•„ì´í…œë§Œ'
    };
    
    // ë“œë¡­ë‹¤ìš´ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ëŠ” ìƒëµ (ë³µì¡í•¨)
}

// ì¸ë²¤í† ë¦¬ í¸ì§‘ ëª¨ë‹¬ ì—´ê¸°
function openInventoryEditor() {
    if (!currentInventory || currentInventory.length === 0) {
        showToast('ì¸ë²¤í† ë¦¬ ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('inventoryEditModal'));
    renderInventoryEditor();
    modal.show();
}

// ì¸ë²¤í† ë¦¬ í¸ì§‘ í™”ë©´ ë Œë”ë§
function renderInventoryEditor() {
    const container = document.getElementById('inventory-editor-container');
    
    let editorHtml = '';
    currentInventory.forEach((item, index) => {
        editorHtml += `
            <div class="row mb-2 align-items-center">
                <div class="col-md-4">
                    <small class="fw-bold">${item.name}</small>
                    <br><small class="text-muted">${item.layer} | ì–¸ë½ Lv.${item.unlock_level}</small>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control form-control-sm" 
                           id="stock-${index}" 
                           value="${item.current_stock}" 
                           min="0" max="9999"
                           data-item="${item.name}">
                </div>
                <div class="col-md-2">
                    <small class="text-muted">/ ${item.max_capacity}</small>
                </div>
                <div class="col-md-3">
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="adjustStock('${index}', -10)">
                            -10
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="adjustStock('${index}', -1)">
                            -1
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="adjustStock('${index}', 1)">
                            +1
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="adjustStock('${index}', 10)">
                            +10
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = editorHtml;
}

// ì¬ê³  ìˆ˜ëŸ‰ ì¡°ì •
function adjustStock(index, delta) {
    const input = document.getElementById(`stock-${index}`);
    const currentValue = parseInt(input.value) || 0;
    const newValue = Math.max(0, Math.min(9999, currentValue + delta));
    input.value = newValue;
}

// ì¸ë²¤í† ë¦¬ ì—…ë°ì´íŠ¸ ì ìš©
function applyInventoryChanges() {
    const updates = {};
    let hasChanges = false;
    
    currentInventory.forEach((item, index) => {
        const input = document.getElementById(`stock-${index}`);
        const newValue = parseInt(input.value) || 0;
        if (newValue !== item.current_stock) {
            updates[item.name] = newValue;
            hasChanges = true;
        }
    });
    
    if (!hasChanges) {
        showToast('ë³€ê²½ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.', 'info');
        return;
    }
    
    fetch('/api/sungdae/inventory/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ updates: updates })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            // ëª¨ë‹¬ ë‹«ê¸°
            bootstrap.Modal.getInstance(document.getElementById('inventoryEditModal')).hide();
            // ì¸ë²¤í† ë¦¬ ìƒˆë¡œê³ ì¹¨
            refreshInventory();
        } else {
            showToast('ì¸ë²¤í† ë¦¬ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('API ìš”ì²­ ì‹¤íŒ¨: ' + error, 'error');
    });
}

// ì¸ë²¤í† ë¦¬ ì´ˆê¸°í™”
function resetInventory() {
    if (!confirm('ì •ë§ë¡œ ì¸ë²¤í† ë¦¬ë¥¼ ì´ˆê¸° ìƒíƒœë¡œ ì¬ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    fetch('/api/sungdae/inventory/reset', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            refreshInventory();
        } else {
            showToast('ì¸ë²¤í† ë¦¬ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('API ìš”ì²­ ì‹¤íŒ¨: ' + error, 'error');
    });
}
</script>

<!-- ì¸ë²¤í† ë¦¬ í¸ì§‘ ëª¨ë‹¬ -->
<div class="modal fade" id="inventoryEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>ì¸ë²¤í† ë¦¬ í¸ì§‘
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4"><strong>ì•„ì´í…œ</strong></div>
                    <div class="col-md-3"><strong>í˜„ì¬ ìˆ˜ëŸ‰</strong></div>
                    <div class="col-md-2"><strong>ìµœëŒ€</strong></div>
                    <div class="col-md-3"><strong>ì¡°ì •</strong></div>
                </div>
                <div id="inventory-editor-container" style="max-height: 400px; overflow-y: auto;">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="applyInventoryChanges()">
                    <i class="fas fa-save me-1"></i>ì ìš©
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}