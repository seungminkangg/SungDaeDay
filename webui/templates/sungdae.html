{% extends "base.html" %}

{% block title %}ì„±ëŒ€ëª¨ë“œ - Township ë‹¤ì´ë‚˜ë¯¹ ë°¸ëŸ°ì‹±{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="display-6 fw-bold text-primary mb-4">
            <i class="fas fa-train me-2"></i>ì„±ëŒ€ëª¨ë“œ ì‹œë®¬ë ˆì´í„°
            <span class="badge bg-success ms-2">Township v2.1</span>
        </h1>
        <p class="lead text-muted mb-4">ë‹¤ì´ë‚˜ë¯¹ ë°¸ëŸ°ì‹± ì‹œìŠ¤í…œ</p>
    </div>
</div>

<div class="row">
    <!-- ì‹œë®¬ë ˆì´í„° ì»¨íŠ¸ë¡¤ -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cog me-2"></i>ì„±ëŒ€ëª¨ë“œ ì„¤ì •
                </h5>
            </div>
            <div class="card-body">
                <!-- í”Œë ˆì´ì–´ ë ˆë²¨ -->
                <div class="mb-3">
                    <label class="form-label">í”Œë ˆì´ì–´ ë ˆë²¨</label>
                    <input type="range" class="form-range" id="sungdae-player-level" min="1" max="100" value="50">
                    <div class="d-flex justify-content-between">
                        <small>1</small>
                        <small id="sungdae-level-display">50</small>
                        <small>100</small>
                    </div>
                </div>

                <!-- ë‚©í’ˆ íƒ€ì… ì„ íƒ -->
                <div class="mb-3">
                    <label class="form-label">ë‚©í’ˆ íƒ€ì…</label>
                    <select class="form-select" id="sungdae-delivery-type">
                        <option value="Truck">ğŸšš íŠ¸ëŸ­ ë‚©í’ˆ</option>
                        <option value="Train">ğŸš‚ ê¸°ì°¨ ë‚©í’ˆ</option>
                    </select>
                </div>

                <!-- ìŠ¤íŠ¸ëŸ¬ê¸€ ìŠ¤ì½”ì–´ ìˆ˜ë™ ì„¤ì • -->
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <label class="form-label mb-0 me-2">ìŠ¤íŠ¸ëŸ¬ê¸€ ìŠ¤ì½”ì–´</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="manual-struggle">
                            <label class="form-check-label" for="manual-struggle">ìˆ˜ë™</label>
                        </div>
                    </div>
                    <input type="range" class="form-range" id="sungdae-struggle-score" min="0" max="100" value="50" disabled>
                    <div class="d-flex justify-content-between">
                        <small>ì‰¬ì›€ (0)</small>
                        <small id="struggle-display">50</small>
                        <small>ì–´ë ¤ì›€ (100)</small>
                    </div>
                </div>

                <!-- ìƒì„± ë²„íŠ¼ë“¤ -->
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="generateSungdaeOrder()">
                        <i class="fas fa-plus me-2"></i>ë‹¨ì¼ ì£¼ë¬¸ ìƒì„±
                    </button>
                    <button class="btn btn-outline-primary" onclick="generateBatchOrders()">
                        <i class="fas fa-layer-group me-2"></i>ë°°ì¹˜ ìƒì„± (5ê°œ)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ë‹¤ì´ë‚˜ë¯¹ ë°¸ëŸ°ì‹± ìƒíƒœ -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-balance-scale me-2"></i>ë‹¤ì´ë‚˜ë¯¹ ë°¸ëŸ°ì‹±
                </h5>
            </div>
            <div class="card-body">
                <div id="dynamic-balancing-status">
                    <!-- ë°¸ëŸ°ì‹± ì§€í‘œ -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>ì••ë ¥ ì§€ìˆ˜</small>
                            <small id="pressure-index">-</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="pressure-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>í¬ì†Œì„± ì§€ìˆ˜</small>
                            <small id="scarcity-index">-</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="scarcity-bar" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>ë‹¤ì–‘ì„± ì ìˆ˜</small>
                            <small id="diversity-score">-</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="diversity-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>íš¨ìœ¨ì„± ë“±ê¸‰</small>
                            <small id="efficiency-rating">-</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="efficiency-bar" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- ì‹œìŠ¤í…œ ìƒíƒœ ìš”ì•½ -->
                    <div id="sungdae-system-status" class="mt-3 p-2 bg-light rounded">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p class="mb-0 small">ì´ˆê¸°í™” ì¤‘...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- ìƒì„±ëœ ì£¼ë¬¸ í‘œì‹œ -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>ìƒì„±ëœ ì£¼ë¬¸
                </h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearSungdaeOrders()">
                    <i class="fas fa-trash me-1"></i>ëª¨ë‘ ì‚­ì œ
                </button>
            </div>
            <div class="card-body">
                <div id="sungdae-orders-container">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-truck fa-2x mb-2"></i>
                        <p>ì•„ì§ ìƒì„±ëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p class="small">ìœ„ì˜ ì„¤ì •ì„ ì¡°ì •í•˜ê³  ì£¼ë¬¸ì„ ìƒì„±í•´ë³´ì„¸ìš”.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ê³ ê¸‰ ì»¨íŠ¸ë¡¤ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tools me-2"></i>ê³ ê¸‰ ì»¨íŠ¸ë¡¤
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-3">
                        <button class="btn btn-outline-info w-100" onclick="simulateTime(1)">
                            <i class="fas fa-forward me-1"></i>1ì‹œê°„ ê²½ê³¼
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-warning w-100" onclick="getAvailableItems()">
                            <i class="fas fa-box me-1"></i>ì•„ì´í…œ ëª©ë¡
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-success w-100" onclick="refreshSystemStatus()">
                            <i class="fas fa-sync me-1"></i>ìƒíƒœ ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary w-100" onclick="resetSimulator()">
                            <i class="fas fa-undo me-1"></i>ì‹œë®¬ë ˆì´í„° ë¦¬ì…‹
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ì„±ëŒ€ëª¨ë“œ ì „ìš© JavaScript
let sungdaeOrders = [];

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    // ë ˆë²¨ ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
    document.getElementById('sungdae-player-level').addEventListener('input', function() {
        document.getElementById('sungdae-level-display').textContent = this.value;
    });

    // ìŠ¤íŠ¸ëŸ¬ê¸€ ìŠ¤ì½”ì–´ ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
    document.getElementById('sungdae-struggle-score').addEventListener('input', function() {
        document.getElementById('struggle-display').textContent = this.value;
    });

    // ìˆ˜ë™ ìŠ¤íŠ¸ëŸ¬ê¸€ ìŠ¤ì½”ì–´ í† ê¸€
    document.getElementById('manual-struggle').addEventListener('change', function() {
        const slider = document.getElementById('sungdae-struggle-score');
        slider.disabled = !this.checked;
        
        if (this.checked) {
            // ìˆ˜ë™ ì„¤ì •ìœ¼ë¡œ ìŠ¤íŠ¸ëŸ¬ê¸€ ìŠ¤ì½”ì–´ ì ìš©
            adjustStruggleScore(slider.value);
        }
    });

    // ì´ˆê¸° ì‹œìŠ¤í…œ ìƒíƒœ ë¡œë“œ
    refreshSystemStatus();
});

// ë‹¨ì¼ ì£¼ë¬¸ ìƒì„±
function generateSungdaeOrder() {
    const playerLevel = document.getElementById('sungdae-player-level').value;
    const deliveryType = document.getElementById('sungdae-delivery-type').value;
    const manualStruggle = document.getElementById('manual-struggle').checked;
    const struggleScore = manualStruggle ? document.getElementById('sungdae-struggle-score').value : null;

    const data = {
        player_level: parseInt(playerLevel),
        delivery_type: deliveryType,
        struggle_score: struggleScore ? parseFloat(struggleScore) : null,
        use_struggle_adjustment: true
    };

    fetch('/api/sungdae/generate-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addOrderToDisplay(data.order);
            updateSystemStatus(data.system_status);
        } else {
            alert('ì£¼ë¬¸ ìƒì„± ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('API ìš”ì²­ ì‹¤íŒ¨: ' + error);
    });
}

// ë°°ì¹˜ ì£¼ë¬¸ ìƒì„±
function generateBatchOrders() {
    const deliveryType = document.getElementById('sungdae-delivery-type').value;
    const data = {
        count: 5,
        delivery_types: [deliveryType]
    };

    fetch('/api/sungdae/batch-orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ë°°ì¹˜ ì£¼ë¬¸ì„ ì—­ìˆœìœ¼ë¡œ ì¶”ê°€í•´ì„œ ìµœì‹ ì´ ìœ„ì— ì˜¤ë„ë¡ í•¨
            data.orders.reverse().forEach(order => addOrderToDisplay(order));
            updateSystemStatus(data.system_status);
        } else {
            alert('ë°°ì¹˜ ìƒì„± ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('API ìš”ì²­ ì‹¤íŒ¨: ' + error);
    });
}

// ì£¼ë¬¸ì„ í™”ë©´ì— ì¶”ê°€
function addOrderToDisplay(order) {
    // ìµœì‹  ì£¼ë¬¸ì„ ì•ì— ì¶”ê°€ (unshift ì‚¬ìš©)
    sungdaeOrders.unshift(order);
    renderOrders();
    // ë‹¤ì´ë‚˜ë¯¹ ë°¸ëŸ°ì‹± ë°ì´í„°ë„ ì—…ë°ì´íŠ¸
    if (order.dynamic_balancing_data) {
        updateDynamicBalancingDisplay(order.dynamic_balancing_data);
    }
}

// ì£¼ë¬¸ ëª©ë¡ ë Œë”ë§
function renderOrders() {
    const container = document.getElementById('sungdae-orders-container');
    
    if (sungdaeOrders.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-truck fa-2x mb-2"></i>
                <p>ì•„ì§ ìƒì„±ëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                <p class="small">ìœ„ì˜ ì„¤ì •ì„ ì¡°ì •í•˜ê³  ì£¼ë¬¸ì„ ìƒì„±í•´ë³´ì„¸ìš”.</p>
            </div>
        `;
        return;
    }

    const ordersHtml = sungdaeOrders.map((order, index) => {
        const difficultyColor = {
            'ì‰¬ì›€': 'success',
            'ë³´í†µ': 'primary', 
            'ì–´ë ¤ì›€': 'warning',
            'ë§¤ìš°ì–´ë ¤ì›€': 'danger'
        }[order.difficulty] || 'secondary';

        const deliveryIcon = order.delivery_type === 'Train' ? 'fas fa-train' : 'fas fa-truck';
        const deliveryColor = order.delivery_type === 'Train' ? 'info' : 'primary';

        const itemsHtml = Object.entries(order.items).map(([item, quantity]) => 
            `<span class="badge bg-light text-dark me-1">${item}: ${quantity}</span>`
        ).join('');

        // Township ê¸°ì°¨ ë©”íƒ€ë°ì´í„° í‘œì‹œ
        let townshipInfo = '';
        if (order.generation_metadata && order.generation_metadata.township_train_cars) {
            const carInfo = order.generation_metadata.car_distribution;
            townshipInfo = `
                <div class="mt-2 p-2 bg-info bg-opacity-10 rounded">
                    <small class="text-info">
                        <i class="fas fa-train me-1"></i>Township ê¸°ì°¨: ${order.generation_metadata.township_train_cars}ì¹¸, 
                        íš¨ìœ¨: ${carInfo ? carInfo.car_efficiency.toFixed(1) : 'N/A'}
                    </small>
                </div>
            `;
        }

        return `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-0">
                            <i class="${deliveryIcon} text-${deliveryColor} me-2"></i>ì£¼ë¬¸ #${order.id}
                        </h6>
                        <div>
                            <span class="badge bg-${difficultyColor}">${order.difficulty}</span>
                            <span class="badge bg-${deliveryColor} ms-1">${order.delivery_type}</span>
                        </div>
                    </div>
                    <p class="card-text mb-2">${itemsHtml}</p>
                    <div class="row text-muted small">
                        <div class="col-md-4">
                            <i class="fas fa-coins me-1"></i>ê°€ì¹˜: ${order.total_value}
                        </div>
                        <div class="col-md-4">
                            <i class="fas fa-chart-line me-1"></i>ìŠ¤íŠ¸ëŸ¬ê¸€: ${order.struggle_score.toFixed(1)}
                        </div>
                        <div class="col-md-4">
                            <i class="fas fa-clock me-1"></i>ë§Œë£Œ: ${order.expiry_time || 60}ë¶„
                        </div>
                    </div>
                    ${townshipInfo}
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = ordersHtml;
}

// ì‹œìŠ¤í…œ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateSystemStatus(status) {
    const container = document.getElementById('sungdae-system-status');
    
    const healthColor = status.resource_health.deficit > status.resource_health.healthy ? 'danger' : 'success';
    
    container.innerHTML = `
        <div class="row g-1">
            <div class="col-6">
                <div class="text-center">
                    <div class="fs-6 fw-bold">${status.current_struggle_score.toFixed(1)}</div>
                    <small class="text-muted" style="font-size: 0.7rem">ìŠ¤íŠ¸ëŸ¬ê¸€</small>
                </div>
            </div>
            <div class="col-6">
                <div class="text-center">
                    <div class="fs-6 fw-bold">${status.total_orders_generated}</div>
                    <small class="text-muted" style="font-size: 0.7rem">ì´ ì£¼ë¬¸</small>
                </div>
            </div>
            <div class="col-6">
                <div class="text-center">
                    <div class="fs-6 fw-bold text-${healthColor}">${status.deficit_items_count}</div>
                    <small class="text-muted" style="font-size: 0.7rem">ë¶€ì¡±</small>
                </div>
            </div>
            <div class="col-6">
                <div class="text-center">
                    <div class="fs-6 fw-bold">${status.average_struggle_score.toFixed(1)}</div>
                    <small class="text-muted" style="font-size: 0.7rem">í‰ê· </small>
                </div>
            </div>
        </div>
    `;
    
    // ë‹¤ì´ë‚˜ë¯¹ ë°¸ëŸ°ì‹± ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
    if (status.dynamic_balancing_data) {
        updateDynamicBalancingDisplay(status.dynamic_balancing_data);
    }
}

// ë‹¤ì´ë‚˜ë¯¹ ë°¸ëŸ°ì‹± ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
function updateDynamicBalancingDisplay(data) {
    if (!data || !data.balancing_metrics) return;
    
    const metrics = data.balancing_metrics;
    
    // ì••ë ¥ ì§€ìˆ˜ ì—…ë°ì´íŠ¸
    if (metrics.pressure_index !== undefined) {
        document.getElementById('pressure-index').textContent = metrics.pressure_index.toFixed(1);
        const pressureBar = document.getElementById('pressure-bar');
        pressureBar.style.width = `${Math.min(100, metrics.pressure_index)}%`;
        pressureBar.className = `progress-bar ${metrics.pressure_index > 70 ? 'bg-danger' : metrics.pressure_index > 40 ? 'bg-warning' : 'bg-success'}`;
    }
    
    // í¬ì†Œì„± ì§€ìˆ˜ ì—…ë°ì´íŠ¸
    if (metrics.scarcity_index !== undefined) {
        document.getElementById('scarcity-index').textContent = metrics.scarcity_index.toFixed(1);
        document.getElementById('scarcity-bar').style.width = `${Math.min(100, metrics.scarcity_index)}%`;
    }
    
    // ë‹¤ì–‘ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸
    if (metrics.diversity_score !== undefined) {
        document.getElementById('diversity-score').textContent = metrics.diversity_score.toFixed(1);
        document.getElementById('diversity-bar').style.width = `${Math.min(100, metrics.diversity_score)}%`;
    }
    
    // íš¨ìœ¨ì„± ë“±ê¸‰ ì—…ë°ì´íŠ¸
    if (metrics.efficiency_rating !== undefined) {
        document.getElementById('efficiency-rating').textContent = metrics.efficiency_rating.toFixed(1);
        document.getElementById('efficiency-bar').style.width = `${Math.min(100, metrics.efficiency_rating)}%`;
    }
}

// ìŠ¤íŠ¸ëŸ¬ê¸€ ìŠ¤ì½”ì–´ ì¡°ì •
function adjustStruggleScore(newScore) {
    fetch('/api/sungdae/adjust-struggle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ struggle_score: parseFloat(newScore) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateSystemStatus(data.system_status);
        } else {
            alert('ìŠ¤íŠ¸ëŸ¬ê¸€ ìŠ¤ì½”ì–´ ì¡°ì • ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => console.error('Error:', error));
}

// ì‹œê°„ ì‹œë®¬ë ˆì´ì…˜
function simulateTime(hours) {
    fetch('/api/sungdae/simulate-time', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ hours: hours })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateSystemStatus(data.system_status);
            alert(data.message);
        } else {
            alert('ì‹œê°„ ì‹œë®¬ë ˆì´ì…˜ ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => console.error('Error:', error));
}

// ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´í…œ ëª©ë¡
function getAvailableItems() {
    fetch('/api/sungdae/available-items')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const itemsInfo = data.items.map(item => 
                `${item.name} (${item.layer}, ì¬ê³ : ${item.current_stock}/${item.max_capacity})`
            ).join('\n');
            
            alert(`ì´ ${data.total_count}ê°œ ì•„ì´í…œ:\n\n${itemsInfo.substring(0, 1000)}${data.items.length > 20 ? '\n...' : ''}`);
        } else {
            alert('ì•„ì´í…œ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => console.error('Error:', error));
}

// ì‹œìŠ¤í…œ ìƒíƒœ ìƒˆë¡œê³ ì¹¨
function refreshSystemStatus() {
    fetch('/api/sungdae/stats')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateSystemStatus(data.status);
        } else {
            console.error('ì‹œìŠ¤í…œ ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨:', data.error);
        }
    })
    .catch(error => console.error('Error:', error));
}

// ì£¼ë¬¸ ëª©ë¡ ë¹„ìš°ê¸°
function clearSungdaeOrders() {
    if (confirm('ëª¨ë“  ì£¼ë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        sungdaeOrders = [];
        renderOrders();
    }
}

// ì‹œë®¬ë ˆì´í„° ë¦¬ì…‹ (ì‹¤ì œë¡œëŠ” í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨)
function resetSimulator() {
    if (confirm('ì‹œë®¬ë ˆì´í„°ë¥¼ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        location.reload();
    }
}
</script>
{% endblock %}