{% extends "base.html" %}

{% block title %}ì£¼ë¬¸ ê´€ë¦¬ - HayDay Dynamic Balancing{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="display-6 fw-bold text-primary mb-4">
            <i class="fas fa-truck me-2"></i>ì£¼ë¬¸ ìƒì„± & ê´€ë¦¬
        </h1>
    </div>
</div>

<div class="row">
    <!-- ì£¼ë¬¸ ìƒì„± ì„¤ì • -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cog me-2"></i>ì£¼ë¬¸ ìƒì„± ì„¤ì •
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">í”Œë ˆì´ì–´ ë ˆë²¨</label>
                    <input type="range" class="form-range" id="player-level" min="1" max="100" value="20">
                    <div class="d-flex justify-content-between">
                        <small>1</small>
                        <small id="level-display">20</small>
                        <small>100</small>
                    </div>
                </div>
                
                <!-- ê³ ê¸‰ íŒŒë¼ë¯¸í„° ì‹œìŠ¤í…œ -->
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <label class="form-label mb-0 me-2">ğŸ² ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="advanced-mode" onchange="toggleAdvancedMode()">
                            <label class="form-check-label" for="advanced-mode">ê³ ê¸‰ ì„¤ì •</label>
                        </div>
                    </div>
                    
                    <!-- ê¸°ë³¸ ëª¨ë“œ (ëœë¤) -->
                    <div id="basic-mode" class="p-3 border rounded bg-light">
                        <div class="text-center">
                            <i class="fas fa-dice-d20 text-primary fa-2x mb-2"></i>
                            <h6 class="text-primary">ìë™ ì‹œë®¬ë ˆì´ì…˜</h6>
                            <p class="text-muted mb-0">ëª¨ë“  íŒŒë¼ë¯¸í„°ê°€ ì‹¤ì œ HayDayì²˜ëŸ¼ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤</p>
                        </div>
                    </div>
                    
                    <!-- ê³ ê¸‰ ëª¨ë“œ (ìˆ˜ë™) -->
                    <div id="advanced-controls" style="display: none;">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">ì–´ë ¤ì›€ ì§€ìˆ˜</label>
                                <input type="range" class="form-range" id="struggle-score" min="0" max="100" value="50">
                                <div class="d-flex justify-content-between">
                                    <small>ì‰¬ì›€ (0)</small>
                                    <small id="struggle-display">50</small>
                                    <small>ì–´ë ¤ì›€ (100)</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ê°€ì¹˜ ë°°ìœ¨</label>
                                <input type="range" class="form-range" id="value-multiplier" min="0.5" max="3.0" step="0.1" value="1.0">
                                <div class="d-flex justify-content-between">
                                    <small>50%</small>
                                    <small id="value-display">100%</small>
                                    <small>300%</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">íŠ¹ë³„ ì£¼ë¬¸ í™•ë¥  (%)</label>
                                <input type="range" class="form-range" id="special-probability" min="0" max="50" value="10">
                                <div class="d-flex justify-content-between">
                                    <small>ì—†ìŒ</small>
                                    <small id="special-display">10%</small>
                                    <small>50%</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ì•„ì´í…œ ìˆ˜ ë³´ë„ˆìŠ¤</label>
                                <select class="form-select" id="item-bonus">
                                    <option value="0">ê¸°ë³¸</option>
                                    <option value="1">+1ê°œ</option>
                                    <option value="2">+2ê°œ</option>
                                    <option value="-1">-1ê°œ</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- í”„ë¦¬ì…‹ ì‹œìŠ¤í…œ -->
                        <div class="mt-3 pt-3 border-top">
                            <div class="row align-items-end">
                                <div class="col-md-6">
                                    <label class="form-label">í”„ë¦¬ì…‹ ì´ë¦„</label>
                                    <input type="text" class="form-control" id="preset-name" placeholder="ì˜ˆ: ê³ ë‚œì´ë„ í…ŒìŠ¤íŠ¸">
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-primary btn-sm" onclick="savePreset()">
                                            <i class="fas fa-save me-1"></i>ì €ì¥
                                        </button>
                                        <select class="form-select form-select-sm" id="preset-select" onchange="loadPreset()">
                                            <option value="">í”„ë¦¬ì…‹ ì„ íƒ...</option>
                                        </select>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deletePreset()">
                                            <i class="fas fa-trash me-1"></i>ì‚­ì œ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">ë‚©í’ˆ íƒ€ì…</label>
                    <select class="form-select" id="delivery-type">
                        <option value="Truck">ğŸšš íŠ¸ëŸ­ (ë¹ ë¥¸ ë‚©í’ˆ)</option>
                        <option value="Train">ğŸš‚ ê¸°ì°¨ (ëŒ€ëŸ‰ ë‚©í’ˆ)</option>
                        <option value="Boat">â›µ ë³´íŠ¸ (ê³ ê°€ì¹˜ ë‚©í’ˆ)</option>
                    </select>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-lg" onclick="generateOrder()">
                        <i class="fas fa-dice me-1"></i>ì£¼ë¬¸ ìƒì„±
                    </button>
                    <button class="btn btn-outline-secondary" onclick="generateMultipleOrders()">
                        <i class="fas fa-list me-1"></i>5ê°œ ì£¼ë¬¸ ìƒì„±
                    </button>
                </div>
                
                <div id="generation-status" class="mt-3"></div>
            </div>
        </div>
    </div>
    
    <!-- ìƒì„±ëœ ì£¼ë¬¸ ëª©ë¡ -->
    <div class="col-lg-8 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>ìƒì„±ëœ ì£¼ë¬¸ ëª©ë¡
                </h5>
                <button class="btn btn-outline-danger btn-sm" onclick="clearOrders()">
                    <i class="fas fa-trash me-1"></i>ì „ì²´ ì‚­ì œ
                </button>
            </div>
            <div class="card-body">
                <div id="orders-container">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-clipboard-list fa-4x mb-3 opacity-25"></i>
                        <h5>ìƒì„±ëœ ì£¼ë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</h5>
                        <p>ì¢Œì¸¡ì—ì„œ ì„¤ì •ì„ ì¡°ì •í•˜ê³  ì£¼ë¬¸ì„ ìƒì„±í•˜ì„¸ìš”.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- í†µê³„ ë° ë¶„ì„ -->
<div class="row" id="stats-section" style="display: none;">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>ì£¼ë¬¸ í†µê³„ ë¶„ì„
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="order-stats">
                    <!-- í†µê³„ ì¹´ë“œë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
                <div class="row mt-4">
                    <div class="col-lg-6">
                        <canvas id="difficulty-pie-chart"></canvas>
                    </div>
                    <div class="col-lg-6">
                        <canvas id="value-distribution-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let generatedOrders = [];
    
    // ìŠ¬ë¼ì´ë” ê°’ ì—…ë°ì´íŠ¸
    document.getElementById('player-level').addEventListener('input', function() {
        document.getElementById('level-display').textContent = this.value;
    });
    
    document.getElementById('struggle-score').addEventListener('input', function() {
        document.getElementById('struggle-display').textContent = this.value;
    });
    
    document.getElementById('value-multiplier').addEventListener('input', function() {
        document.getElementById('value-display').textContent = (this.value * 100) + '%';
    });
    
    document.getElementById('special-probability').addEventListener('input', function() {
        document.getElementById('special-display').textContent = this.value + '%';
    });
    
    // ê³ ê¸‰ ëª¨ë“œ í† ê¸€ 
    function toggleAdvancedMode() {
        const isAdvanced = document.getElementById('advanced-mode').checked;
        document.getElementById('basic-mode').style.display = isAdvanced ? 'none' : 'block';
        document.getElementById('advanced-controls').style.display = isAdvanced ? 'block' : 'none';
        
        // í”„ë¦¬ì…‹ ë¡œë“œ
        if (isAdvanced) {
            loadPresetList();
        }
    }
    
    // ë‹¨ì¼ ì£¼ë¬¸ ìƒì„±
    function generateOrder() {
        const level = parseInt(document.getElementById('player-level').value);
        const deliveryType = document.getElementById('delivery-type').value;
        const statusDiv = document.getElementById('generation-status');
        const isAdvanced = document.getElementById('advanced-mode').checked;
        
        // ê³ ê¸‰ ëª¨ë“œì—ì„œ íŒŒë¼ë¯¸í„° ìˆ˜ì§‘
        let requestData = {
            player_level: level,
            delivery_type: deliveryType
        };
        
        if (isAdvanced) {
            // ìˆ˜ë™ íŒŒë¼ë¯¸í„°ë“¤
            requestData.struggle_score = parseFloat(document.getElementById('struggle-score').value);
            requestData.value_multiplier = parseFloat(document.getElementById('value-multiplier').value);
            requestData.special_probability = parseInt(document.getElementById('special-probability').value);
            requestData.item_bonus = parseInt(document.getElementById('item-bonus').value);
            requestData.manual_mode = true;
        } else {
            // ìë™ ëª¨ë“œ - ëœë¤ ìƒì„±
            requestData.manual_mode = false;
        }
        
        statusDiv.innerHTML = `
            <div class="alert alert-info">
                <div class="loading me-2"></div>
                ì£¼ë¬¸ ìƒì„± ì¤‘...
            </div>
        `;
        
        fetch('/api/generate-order', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                statusDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }
            
            generatedOrders.unshift(data); // ìµœì‹  ì£¼ë¬¸ì„ ë§¨ ìœ„ì— ì¶”ê°€
            displayOrders();
            updateStatistics();
            statusDiv.innerHTML = `<div class="alert alert-success">ì£¼ë¬¸ ìƒì„± ì™„ë£Œ!</div>`;
            
            // 3ì´ˆ í›„ ë©”ì‹œì§€ ì œê±°
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        })
        .catch(error => {
            statusDiv.innerHTML = `<div class="alert alert-danger">ì˜¤ë¥˜: ${error.message}</div>`;
        });
    }
    
    // ë‹¤ì¤‘ ì£¼ë¬¸ ìƒì„±
    function generateMultipleOrders() {
        const statusDiv = document.getElementById('generation-status');
        statusDiv.innerHTML = `
            <div class="alert alert-info">
                <div class="loading me-2"></div>
                5ê°œ ì£¼ë¬¸ ìƒì„± ì¤‘...
            </div>
        `;
        
        let completed = 0;
        for (let i = 0; i < 5; i++) {
            setTimeout(() => {
                generateSingleOrderSilent().then(() => {
                    completed++;
                    if (completed === 5) {
                        statusDiv.innerHTML = `<div class="alert alert-success">5ê°œ ì£¼ë¬¸ ìƒì„± ì™„ë£Œ!</div>`;
                        setTimeout(() => {
                            statusDiv.innerHTML = '';
                        }, 3000);
                    }
                });
            }, i * 200); // 200ms ê°„ê²©ìœ¼ë¡œ ìƒì„±
        }
    }
    
    // ì¡°ìš©í•œ ì£¼ë¬¸ ìƒì„± (ìƒíƒœ ë©”ì‹œì§€ ì—†ìŒ)
    function generateSingleOrderSilent() {
        const level = parseInt(document.getElementById('player-level').value);
        const deliveryType = document.getElementById('delivery-type').value;
        const isAdvanced = document.getElementById('advanced-mode').checked;
        
        // ê³ ê¸‰ ëª¨ë“œì—ì„œ íŒŒë¼ë¯¸í„° ìˆ˜ì§‘
        let requestData = {
            player_level: level,
            delivery_type: deliveryType
        };
        
        if (isAdvanced) {
            // ìˆ˜ë™ íŒŒë¼ë¯¸í„°ë“¤
            requestData.struggle_score = parseFloat(document.getElementById('struggle-score').value);
            requestData.value_multiplier = parseFloat(document.getElementById('value-multiplier').value);
            requestData.special_probability = parseInt(document.getElementById('special-probability').value);
            requestData.item_bonus = parseInt(document.getElementById('item-bonus').value);
            requestData.manual_mode = true;
        } else {
            // ìë™ ëª¨ë“œ - ëœë¤ ìƒì„±
            requestData.manual_mode = false;
        }
        
        return fetch('/api/generate-order', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (!data.error) {
                generatedOrders.unshift(data);
                displayOrders();
                updateStatistics();
            }
        })
        .catch(error => console.error('Order generation error:', error));
    }
    
    // ì£¼ë¬¸ ëª©ë¡ í‘œì‹œ
    function displayOrders() {
        const container = document.getElementById('orders-container');
        
        if (generatedOrders.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-clipboard-list fa-4x mb-3 opacity-25"></i>
                    <h5>ìƒì„±ëœ ì£¼ë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</h5>
                    <p>ì¢Œì¸¡ì—ì„œ ì„¤ì •ì„ ì¡°ì •í•˜ê³  ì£¼ë¬¸ì„ ìƒì„±í•˜ì„¸ìš”.</p>
                </div>
            `;
            document.getElementById('stats-section').style.display = 'none';
            return;
        }
        
        let html = '';
        generatedOrders.forEach((order, index) => {
            const difficultyColor = {
                'VeryEasy': 'success',
                'Easy': 'info',
                'Normal': 'warning',
                'Hard': 'danger',
                'VeryHard': 'dark'
            }[order.difficulty] || 'secondary';
            
            const deliveryIcon = order.delivery_type === 'Truck' ? 'ğŸšš' : 'ğŸš‚';
            
            let itemsList = '';
            for (const [item, qty] of Object.entries(order.items)) {
                itemsList += `<li><strong>${item}</strong>: ${qty}ê°œ</li>`;
            }
            
            html += `
                <div class="card mb-3" style="border-left: 5px solid var(--bs-${difficultyColor});">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="card-title">
                                ${deliveryIcon} ${order.order_id}
                                <span class="badge bg-${difficultyColor} ms-2">${order.difficulty}</span>
                            </h6>
                            <button class="btn btn-outline-danger btn-sm" onclick="removeOrder(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <p class="card-text">
                                    <strong>ìš”êµ¬ ì•„ì´í…œ:</strong>
                                    <ul class="mt-1 mb-0">${itemsList}</ul>
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="text-muted small">ì´ ê°€ì¹˜</div>
                                <div class="h5 text-success">${formatNumber(order.total_value)} ì½”ì¸</div>
                                <div class="text-muted small">ì–´ë ¤ì›€ ì§€ìˆ˜: ${order.struggle_score.toFixed(1)}</div>
                                <div class="text-warning small">
                                    <i class="fas fa-hourglass-half"></i> ì´ ìƒì‚°ì‹œê°„: ${order.total_production_time || 0}ë¶„
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        document.getElementById('stats-section').style.display = 'block';
    }
    
    // ì£¼ë¬¸ ì œê±°
    function removeOrder(index) {
        generatedOrders.splice(index, 1);
        displayOrders();
        updateStatistics();
    }
    
    // ì „ì²´ ì£¼ë¬¸ ì‚­ì œ
    function clearOrders() {
        if (confirm('ëª¨ë“  ì£¼ë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            generatedOrders = [];
            displayOrders();
        }
    }
    
    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStatistics() {
        if (generatedOrders.length === 0) return;
        
        // ê¸°ë³¸ í†µê³„
        const totalValue = generatedOrders.reduce((sum, order) => sum + order.total_value, 0);
        const avgValue = totalValue / generatedOrders.length;
        const avgStruggle = generatedOrders.reduce((sum, order) => sum + order.struggle_score, 0) / generatedOrders.length;
        
        // ë‚œì´ë„ë³„ ë¶„í¬
        const difficultyCount = {};
        generatedOrders.forEach(order => {
            difficultyCount[order.difficulty] = (difficultyCount[order.difficulty] || 0) + 1;
        });
        
        // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
        document.getElementById('order-stats').innerHTML = `
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <div class="stat-number">${generatedOrders.length}</div>
                        <div class="text-muted">ì´ ì£¼ë¬¸ ìˆ˜</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <div class="stat-number">${formatNumber(Math.round(avgValue))}</div>
                        <div class="text-muted">í‰ê·  ê°€ì¹˜</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <div class="stat-number">${formatNumber(totalValue)}</div>
                        <div class="text-muted">ì´ ê°€ì¹˜</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <div class="stat-number">${avgStruggle.toFixed(1)}</div>
                        <div class="text-muted">í‰ê·  ì–´ë ¤ì›€</div>
                    </div>
                </div>
            </div>
        `;
        
        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        updateCharts(difficultyCount);
    }
    
    // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    function updateCharts(difficultyCount) {
        // ë‚œì´ë„ ë¶„í¬ íŒŒì´ ì°¨íŠ¸
        const difficultyCtx = document.getElementById('difficulty-pie-chart').getContext('2d');
        new Chart(difficultyCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(difficultyCount),
                datasets: [{
                    data: Object.values(difficultyCount),
                    backgroundColor: [
                        '#28a745', '#17a2b8', '#ffc107', '#dc3545', '#6c757d'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'ë‚œì´ë„ ë¶„í¬'
                    },
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // ê°€ì¹˜ ë¶„í¬ ì°¨íŠ¸
        const values = generatedOrders.map(order => order.total_value);
        const valueRanges = { '0-1K': 0, '1K-5K': 0, '5K-10K': 0, '10K+': 0 };
        
        values.forEach(value => {
            if (value < 1000) valueRanges['0-1K']++;
            else if (value < 5000) valueRanges['1K-5K']++;
            else if (value < 10000) valueRanges['5K-10K']++;
            else valueRanges['10K+']++;
        });
        
        const valueCtx = document.getElementById('value-distribution-chart').getContext('2d');
        new Chart(valueCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(valueRanges),
                datasets: [{
                    label: 'ì£¼ë¬¸ ìˆ˜',
                    data: Object.values(valueRanges),
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgb(54, 162, 235)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'ê°€ì¹˜ ë¶„í¬'
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'ì£¼ë¬¸ ìˆ˜'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'ê°€ì¹˜ ë²”ìœ„ (ì½”ì¸)'
                        }
                    }
                }
            }
        });
    }
    
    // í”„ë¦¬ì…‹ ê¸°ëŠ¥ë“¤
    function loadPresetList() {
        const presets = JSON.parse(localStorage.getItem('orderPresets') || '{}');
        const select = document.getElementById('preset-select');
        select.innerHTML = '<option value="">í”„ë¦¬ì…‹ ì„ íƒ...</option>';
        
        for (const name in presets) {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
        }
    }
    
    function savePreset() {
        const name = document.getElementById('preset-name').value.trim();
        if (!name) {
            alert('í”„ë¦¬ì…‹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }
        
        const preset = {
            struggle_score: document.getElementById('struggle-score').value,
            value_multiplier: document.getElementById('value-multiplier').value,
            special_probability: document.getElementById('special-probability').value,
            item_bonus: document.getElementById('item-bonus').value
        };
        
        const presets = JSON.parse(localStorage.getItem('orderPresets') || '{}');
        presets[name] = preset;
        localStorage.setItem('orderPresets', JSON.stringify(presets));
        
        document.getElementById('preset-name').value = '';
        loadPresetList();
        alert('í”„ë¦¬ì…‹ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }
    
    function loadPreset() {
        const name = document.getElementById('preset-select').value;
        if (!name) return;
        
        const presets = JSON.parse(localStorage.getItem('orderPresets') || '{}');
        const preset = presets[name];
        if (!preset) return;
        
        document.getElementById('struggle-score').value = preset.struggle_score;
        document.getElementById('struggle-display').textContent = preset.struggle_score;
        document.getElementById('value-multiplier').value = preset.value_multiplier;
        document.getElementById('value-display').textContent = (preset.value_multiplier * 100) + '%';
        document.getElementById('special-probability').value = preset.special_probability;
        document.getElementById('special-display').textContent = preset.special_probability + '%';
        document.getElementById('item-bonus').value = preset.item_bonus;
    }
    
    function deletePreset() {
        const name = document.getElementById('preset-select').value;
        if (!name) {
            alert('ì‚­ì œí•  í”„ë¦¬ì…‹ì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }
        
        if (confirm(`'${name}' í”„ë¦¬ì…‹ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            const presets = JSON.parse(localStorage.getItem('orderPresets') || '{}');
            delete presets[name];
            localStorage.setItem('orderPresets', JSON.stringify(presets));
            loadPresetList();
            alert('í”„ë¦¬ì…‹ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    // ì§„ì§œ ë„ë§ˆë±€ì²˜ëŸ¼ ê¸°ì–´ë‹¤ë‹ˆëŠ” ì• ë‹ˆë©”ì´ì…˜ 
    function createLizard() {
        const lizard = document.createElement('div');
        lizard.className = 'crawling-lizard';
        lizard.innerHTML = 'ğŸ¦';
        lizard.style.cssText = `
            position: fixed;
            font-size: 60px;
            z-index: 9999;
            pointer-events: all;
            cursor: pointer;
            opacity: 0.9;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
            user-select: none;
        `;
        
        // ëœë¤ ì‹œì‘ ìœ„ì¹˜
        let currentX = Math.random() * (window.innerWidth - 60);
        let currentY = Math.random() * (window.innerHeight - 60);
        lizard.style.left = currentX + 'px';
        lizard.style.top = currentY + 'px';
        
        document.body.appendChild(lizard);
        
        let isExploded = false;
        let moveTimeout;
        
        // í­ë°œ íš¨ê³¼
        function explodeLizard(event) {
            if (isExploded) return;
            isExploded = true;
            clearTimeout(moveTimeout);
            
            const rect = lizard.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            // í­ë°œ íŒŒí‹°í´ ìƒì„±
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.style.cssText = `
                    position: fixed;
                    width: 6px;
                    height: 6px;
                    background: ${['#ff6b35', '#f7931e', '#ffdc00', '#c5d86d', '#00a8cc'][Math.floor(Math.random() * 5)]};
                    border-radius: 50%;
                    pointer-events: none;
                    z-index: 10000;
                    left: ${centerX}px;
                    top: ${centerY}px;
                `;
                
                document.body.appendChild(particle);
                
                // íŒŒí‹°í´ í­ë°œ ì• ë‹ˆë©”ì´ì…˜
                const angle = (Math.PI * 2 * i) / 20;
                const velocity = 50 + Math.random() * 100;
                const deltaX = Math.cos(angle) * velocity;
                const deltaY = Math.sin(angle) * velocity;
                
                particle.animate([
                    { transform: 'translate(0, 0) scale(1)', opacity: 1 },
                    { transform: `translate(${deltaX}px, ${deltaY}px) scale(0)`, opacity: 0 }
                ], {
                    duration: 800 + Math.random() * 400,
                    easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)',
                    fill: 'forwards'
                }).addEventListener('finish', () => particle.remove());
            }
            
            // ë„ë§ˆë±€ í­ë°œ ì• ë‹ˆë©”ì´ì…˜
            lizard.animate([
                { transform: 'scale(1) rotate(0deg)', opacity: 1 },
                { transform: 'scale(2) rotate(180deg)', opacity: 0 }
            ], {
                duration: 300,
                easing: 'cubic-bezier(0.68, -0.55, 0.265, 1.55)',
                fill: 'forwards'
            }).addEventListener('finish', () => {
                lizard.style.display = 'none';
                
                // 10ì´ˆ í›„ ë¶€í™œ
                setTimeout(() => {
                    if (lizard.parentNode) {
                        lizard.style.display = 'block';
                        lizard.style.transform = 'scale(1) rotate(0deg)';
                        lizard.style.opacity = '0.9';
                        isExploded = false;
                        crawlLizard();
                    }
                }, 10000);
            });
        }
        
        // ì§„ì§œ ë„ë§ˆë±€ì²˜ëŸ¼ ê¸°ì–´ë‹¤ë‹ˆê¸°
        function crawlLizard() {
            if (isExploded) return;
            
            const targetX = Math.random() * (window.innerWidth - 60);
            const targetY = Math.random() * (window.innerHeight - 60);
            
            const deltaX = targetX - currentX;
            const deltaY = targetY - currentY;
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            const duration = Math.max(2000, distance * 3); // ê±°ë¦¬ì— ë¹„ë¡€í•œ ì‹œê°„
            
            // ë°©í–¥ì— ë”°ë¥¸ íšŒì „
            const angle = Math.atan2(deltaY, deltaX) * (180 / Math.PI);
            
            // ì§„ì§œ ë„ë§ˆë±€ì²˜ëŸ¼ êµ¬ë¶ˆêµ¬ë¶ˆ ê¸°ì–´ë‹¤ë‹ˆëŠ” ì• ë‹ˆë©”ì´ì…˜
            lizard.animate([
                { 
                    left: currentX + 'px', 
                    top: currentY + 'px', 
                    transform: `rotate(${angle}deg) scaleX(1)` 
                },
                { 
                    left: currentX + deltaX * 0.3 + 'px', 
                    top: currentY + deltaY * 0.3 + 'px', 
                    transform: `rotate(${angle + 5}deg) scaleX(1.1)` 
                },
                { 
                    left: currentX + deltaX * 0.7 + 'px', 
                    top: currentY + deltaY * 0.7 + 'px', 
                    transform: `rotate(${angle - 5}deg) scaleX(0.9)` 
                },
                { 
                    left: targetX + 'px', 
                    top: targetY + 'px', 
                    transform: `rotate(${angle}deg) scaleX(1)` 
                }
            ], {
                duration: duration,
                easing: 'cubic-bezier(0.645, 0.045, 0.355, 1)', // ìì—°ìŠ¤ëŸ¬ìš´ ë™ë¬¼ ì›€ì§ì„
                fill: 'forwards'
            }).addEventListener('finish', () => {
                currentX = targetX;
                currentY = targetY;
                
                // ì ì‹œ ë©ˆì¶¤ (ì‹¤ì œ ë„ë§ˆë±€ì²˜ëŸ¼)
                moveTimeout = setTimeout(crawlLizard, 1000 + Math.random() * 2000);
            });
        }
        
        // í´ë¦­ ì´ë²¤íŠ¸
        lizard.addEventListener('click', explodeLizard);
        
        // ì²« ì›€ì§ì„ ì‹œì‘
        setTimeout(crawlLizard, 500);
        
        // 5ë¶„ í›„ ì œê±°
        setTimeout(() => {
            if (lizard.parentNode) {
                lizard.remove();
            }
        }, 300000);
    }
    
    // í˜ì´ì§€ ë¡œë“œì‹œ ë„ë§ˆë±€ ìƒì„±
    document.addEventListener('DOMContentLoaded', function() {
        // 10ì´ˆ í›„ ì²« ë„ë§ˆë±€
        setTimeout(createLizard, 10000);
        
        // ì´í›„ 2-5ë¶„ë§ˆë‹¤ ëœë¤í•˜ê²Œ ìƒì„±
        setInterval(() => {
            if (Math.random() < 0.3) {
                createLizard();
            }
        }, 120000); // 2ë¶„ë§ˆë‹¤ ì²´í¬
    });
</script>
{% endblock %}