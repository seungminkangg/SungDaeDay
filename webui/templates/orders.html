{% extends "base.html" %}

{% block title %}ì£¼ë¬¸ ê´€ë¦¬ - HayDay Dynamic Balancing{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="display-6 fw-bold text-primary mb-4">
            <i class="fas fa-truck me-2"></i>ì£¼ë¬¸ ìƒì„± & ê´€ë¦¬
        </h1>
    </div>
</div>

<div class="row">
    <!-- ì£¼ë¬¸ ìƒì„± ì„¤ì • -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cog me-2"></i>ì£¼ë¬¸ ìƒì„± ì„¤ì •
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">í”Œë ˆì´ì–´ ë ˆë²¨</label>
                    <input type="range" class="form-range" id="player-level" min="1" max="100" value="20">
                    <div class="d-flex justify-content-between">
                        <small>1</small>
                        <small id="level-display">20</small>
                        <small>100</small>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">ì–´ë ¤ì›€ ì§€ìˆ˜ (Struggle Score)</label>
                    <input type="range" class="form-range" id="struggle-score" min="0" max="100" value="50">
                    <div class="d-flex justify-content-between">
                        <small>ì‰¬ì›€ (0)</small>
                        <small id="struggle-display">50</small>
                        <small>ì–´ë ¤ì›€ (100)</small>
                    </div>
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        í”Œë ˆì´ì–´ì˜ í˜„ì¬ ê²Œì„ ì–´ë ¤ì›€ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">ë‚©í’ˆ íƒ€ì…</label>
                    <select class="form-select" id="delivery-type">
                        <option value="Truck">ğŸšš íŠ¸ëŸ­ (ë¹ ë¥¸ ë‚©í’ˆ)</option>
                        <option value="Train">ğŸš‚ ê¸°ì°¨ (ëŒ€ëŸ‰ ë‚©í’ˆ)</option>
                    </select>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-lg" onclick="generateOrder()">
                        <i class="fas fa-dice me-1"></i>ì£¼ë¬¸ ìƒì„±
                    </button>
                    <button class="btn btn-outline-secondary" onclick="generateMultipleOrders()">
                        <i class="fas fa-list me-1"></i>5ê°œ ì£¼ë¬¸ ìƒì„±
                    </button>
                </div>
                
                <div id="generation-status" class="mt-3"></div>
            </div>
        </div>
    </div>
    
    <!-- ìƒì„±ëœ ì£¼ë¬¸ ëª©ë¡ -->
    <div class="col-lg-8 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>ìƒì„±ëœ ì£¼ë¬¸ ëª©ë¡
                </h5>
                <button class="btn btn-outline-danger btn-sm" onclick="clearOrders()">
                    <i class="fas fa-trash me-1"></i>ì „ì²´ ì‚­ì œ
                </button>
            </div>
            <div class="card-body">
                <div id="orders-container">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-clipboard-list fa-4x mb-3 opacity-25"></i>
                        <h5>ìƒì„±ëœ ì£¼ë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</h5>
                        <p>ì¢Œì¸¡ì—ì„œ ì„¤ì •ì„ ì¡°ì •í•˜ê³  ì£¼ë¬¸ì„ ìƒì„±í•˜ì„¸ìš”.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- í†µê³„ ë° ë¶„ì„ -->
<div class="row" id="stats-section" style="display: none;">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>ì£¼ë¬¸ í†µê³„ ë¶„ì„
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="order-stats">
                    <!-- í†µê³„ ì¹´ë“œë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
                <div class="row mt-4">
                    <div class="col-lg-6">
                        <canvas id="difficulty-pie-chart"></canvas>
                    </div>
                    <div class="col-lg-6">
                        <canvas id="value-distribution-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let generatedOrders = [];
    
    // ìŠ¬ë¼ì´ë” ê°’ ì—…ë°ì´íŠ¸
    document.getElementById('player-level').addEventListener('input', function() {
        document.getElementById('level-display').textContent = this.value;
    });
    
    document.getElementById('struggle-score').addEventListener('input', function() {
        document.getElementById('struggle-display').textContent = this.value;
    });
    
    // ë‹¨ì¼ ì£¼ë¬¸ ìƒì„±
    function generateOrder() {
        const level = parseInt(document.getElementById('player-level').value);
        const struggle = parseFloat(document.getElementById('struggle-score').value);
        const deliveryType = document.getElementById('delivery-type').value;
        const statusDiv = document.getElementById('generation-status');
        
        statusDiv.innerHTML = `
            <div class="alert alert-info">
                <div class="loading me-2"></div>
                ì£¼ë¬¸ ìƒì„± ì¤‘...
            </div>
        `;
        
        fetch('/api/generate-order', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                player_level: level,
                struggle_score: struggle,
                delivery_type: deliveryType
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                statusDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }
            
            generatedOrders.unshift(data); // ìµœì‹  ì£¼ë¬¸ì„ ë§¨ ìœ„ì— ì¶”ê°€
            displayOrders();
            updateStatistics();
            statusDiv.innerHTML = `<div class="alert alert-success">ì£¼ë¬¸ ìƒì„± ì™„ë£Œ!</div>`;
            
            // 3ì´ˆ í›„ ë©”ì‹œì§€ ì œê±°
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        })
        .catch(error => {
            statusDiv.innerHTML = `<div class="alert alert-danger">ì˜¤ë¥˜: ${error.message}</div>`;
        });
    }
    
    // ë‹¤ì¤‘ ì£¼ë¬¸ ìƒì„±
    function generateMultipleOrders() {
        const statusDiv = document.getElementById('generation-status');
        statusDiv.innerHTML = `
            <div class="alert alert-info">
                <div class="loading me-2"></div>
                5ê°œ ì£¼ë¬¸ ìƒì„± ì¤‘...
            </div>
        `;
        
        let completed = 0;
        for (let i = 0; i < 5; i++) {
            setTimeout(() => {
                generateSingleOrderSilent().then(() => {
                    completed++;
                    if (completed === 5) {
                        statusDiv.innerHTML = `<div class="alert alert-success">5ê°œ ì£¼ë¬¸ ìƒì„± ì™„ë£Œ!</div>`;
                        setTimeout(() => {
                            statusDiv.innerHTML = '';
                        }, 3000);
                    }
                });
            }, i * 200); // 200ms ê°„ê²©ìœ¼ë¡œ ìƒì„±
        }
    }
    
    // ì¡°ìš©í•œ ì£¼ë¬¸ ìƒì„± (ìƒíƒœ ë©”ì‹œì§€ ì—†ìŒ)
    function generateSingleOrderSilent() {
        const level = parseInt(document.getElementById('player-level').value);
        const struggle = parseFloat(document.getElementById('struggle-score').value);
        const deliveryType = document.getElementById('delivery-type').value;
        
        return fetch('/api/generate-order', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                player_level: level,
                struggle_score: struggle,
                delivery_type: deliveryType
            })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.error) {
                generatedOrders.unshift(data);
                displayOrders();
                updateStatistics();
            }
        })
        .catch(error => console.error('Order generation error:', error));
    }
    
    // ì£¼ë¬¸ ëª©ë¡ í‘œì‹œ
    function displayOrders() {
        const container = document.getElementById('orders-container');
        
        if (generatedOrders.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-clipboard-list fa-4x mb-3 opacity-25"></i>
                    <h5>ìƒì„±ëœ ì£¼ë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</h5>
                    <p>ì¢Œì¸¡ì—ì„œ ì„¤ì •ì„ ì¡°ì •í•˜ê³  ì£¼ë¬¸ì„ ìƒì„±í•˜ì„¸ìš”.</p>
                </div>
            `;
            document.getElementById('stats-section').style.display = 'none';
            return;
        }
        
        let html = '';
        generatedOrders.forEach((order, index) => {
            const difficultyColor = {
                'VeryEasy': 'success',
                'Easy': 'info',
                'Normal': 'warning',
                'Hard': 'danger',
                'VeryHard': 'dark'
            }[order.difficulty] || 'secondary';
            
            const deliveryIcon = order.delivery_type === 'Truck' ? 'ğŸšš' : 'ğŸš‚';
            
            let itemsList = '';
            for (const [item, qty] of Object.entries(order.items)) {
                itemsList += `<li><strong>${item}</strong>: ${qty}ê°œ</li>`;
            }
            
            html += `
                <div class="card mb-3" style="border-left: 5px solid var(--bs-${difficultyColor});">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="card-title">
                                ${deliveryIcon} ${order.order_id}
                                <span class="badge bg-${difficultyColor} ms-2">${order.difficulty}</span>
                            </h6>
                            <button class="btn btn-outline-danger btn-sm" onclick="removeOrder(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <p class="card-text">
                                    <strong>ìš”êµ¬ ì•„ì´í…œ:</strong>
                                    <ul class="mt-1 mb-0">${itemsList}</ul>
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="text-muted small">ì´ ê°€ì¹˜</div>
                                <div class="h5 text-success">${formatNumber(order.total_value)} ì½”ì¸</div>
                                <div class="text-muted small">ì–´ë ¤ì›€ ì§€ìˆ˜: ${order.struggle_score.toFixed(1)}</div>
                                <div class="text-info small mt-2">
                                    <i class="fas fa-clock"></i> í‰ê·  ìƒì‚°ì‹œê°„: ${order.avg_production_time || 0}ë¶„
                                </div>
                                <div class="text-warning small">
                                    <i class="fas fa-hourglass-half"></i> ì´ ìƒì‚°ì‹œê°„: ${order.total_production_time || 0}ë¶„
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        document.getElementById('stats-section').style.display = 'block';
    }
    
    // ì£¼ë¬¸ ì œê±°
    function removeOrder(index) {
        generatedOrders.splice(index, 1);
        displayOrders();
        updateStatistics();
    }
    
    // ì „ì²´ ì£¼ë¬¸ ì‚­ì œ
    function clearOrders() {
        if (confirm('ëª¨ë“  ì£¼ë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            generatedOrders = [];
            displayOrders();
        }
    }
    
    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStatistics() {
        if (generatedOrders.length === 0) return;
        
        // ê¸°ë³¸ í†µê³„
        const totalValue = generatedOrders.reduce((sum, order) => sum + order.total_value, 0);
        const avgValue = totalValue / generatedOrders.length;
        const avgStruggle = generatedOrders.reduce((sum, order) => sum + order.struggle_score, 0) / generatedOrders.length;
        
        // ë‚œì´ë„ë³„ ë¶„í¬
        const difficultyCount = {};
        generatedOrders.forEach(order => {
            difficultyCount[order.difficulty] = (difficultyCount[order.difficulty] || 0) + 1;
        });
        
        // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
        document.getElementById('order-stats').innerHTML = `
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <div class="stat-number">${generatedOrders.length}</div>
                        <div class="text-muted">ì´ ì£¼ë¬¸ ìˆ˜</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <div class="stat-number">${formatNumber(Math.round(avgValue))}</div>
                        <div class="text-muted">í‰ê·  ê°€ì¹˜</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <div class="stat-number">${formatNumber(totalValue)}</div>
                        <div class="text-muted">ì´ ê°€ì¹˜</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <div class="stat-number">${avgStruggle.toFixed(1)}</div>
                        <div class="text-muted">í‰ê·  ì–´ë ¤ì›€</div>
                    </div>
                </div>
            </div>
        `;
        
        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        updateCharts(difficultyCount);
    }
    
    // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    function updateCharts(difficultyCount) {
        // ë‚œì´ë„ ë¶„í¬ íŒŒì´ ì°¨íŠ¸
        const difficultyCtx = document.getElementById('difficulty-pie-chart').getContext('2d');
        new Chart(difficultyCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(difficultyCount),
                datasets: [{
                    data: Object.values(difficultyCount),
                    backgroundColor: [
                        '#28a745', '#17a2b8', '#ffc107', '#dc3545', '#6c757d'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'ë‚œì´ë„ ë¶„í¬'
                    },
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // ê°€ì¹˜ ë¶„í¬ ì°¨íŠ¸
        const values = generatedOrders.map(order => order.total_value);
        const valueRanges = { '0-1K': 0, '1K-5K': 0, '5K-10K': 0, '10K+': 0 };
        
        values.forEach(value => {
            if (value < 1000) valueRanges['0-1K']++;
            else if (value < 5000) valueRanges['1K-5K']++;
            else if (value < 10000) valueRanges['5K-10K']++;
            else valueRanges['10K+']++;
        });
        
        const valueCtx = document.getElementById('value-distribution-chart').getContext('2d');
        new Chart(valueCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(valueRanges),
                datasets: [{
                    label: 'ì£¼ë¬¸ ìˆ˜',
                    data: Object.values(valueRanges),
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgb(54, 162, 235)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'ê°€ì¹˜ ë¶„í¬'
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'ì£¼ë¬¸ ìˆ˜'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'ê°€ì¹˜ ë²”ìœ„ (ì½”ì¸)'
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}