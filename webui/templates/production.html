{% extends "base.html" %}

{% block title %}생산 체인 분석 - HayDay Dynamic Balancing{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="display-6 fw-bold text-primary mb-4">
            <i class="fas fa-industry me-2"></i>생산 체인 분석
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>생산 효율성 분석
                </h5>
            </div>
            <div class="card-body">
                <div id="production-loading" class="text-center py-4">
                    <div class="loading"></div>
                    <p class="mt-2">생산 체인 데이터 로딩 중...</p>
                </div>
                <div id="production-content" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="production-table">
                            <thead class="table-primary">
                                <tr>
                                    <th>아이템명</th>
                                    <th>건물</th>
                                    <th>레벨</th>
                                    <th>재료 개수</th>
                                    <th>필요 재료</th>
                                    <th>생산 시간</th>
                                    <th>판매 가격</th>
                                    <th>분당 효율</th>
                                    <th>시간당 수익</th>
                                    <th>수익률 %</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row" id="charts-row" style="display: none;">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">건물별 생산량</h6>
            </div>
            <div class="card-body">
                <canvas id="building-chart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">효율성 분포</h6>
            </div>
            <div class="card-body">
                <canvas id="efficiency-chart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let productionData = [];
    
    // 페이지 로드시 데이터 가져오기
    document.addEventListener('DOMContentLoaded', function() {
        loadProductionData();
    });
    
    function loadProductionData() {
        fetch('/api/production-chains')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('production-loading').innerHTML = 
                        `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                
                productionData = data;
                displayProductionTable(data);
                createCharts(data);
                
                document.getElementById('production-loading').style.display = 'none';
                document.getElementById('production-content').style.display = 'block';
                document.getElementById('charts-row').style.display = 'block';
            })
            .catch(error => {
                document.getElementById('production-loading').innerHTML = 
                    `<div class="alert alert-danger">데이터 로드 실패: ${error.message}</div>`;
            });
    }
    
    function displayProductionTable(data) {
        const tbody = document.querySelector('#production-table tbody');
        tbody.innerHTML = '';
        
        data.slice(0, 100).forEach(item => { // 상위 100개 표시 (Reddit 스타일)
            const row = document.createElement('tr');
            
            // 효율성별 색상 코딩
            const efficiencyClass = item.efficiency_per_min > 50 ? 'bg-success' :
                                   item.efficiency_per_min > 20 ? 'bg-warning' : 'bg-secondary';
            
            const profitClass = item.profit_margin_percent > 50 ? 'text-success' :
                               item.profit_margin_percent > 30 ? 'text-warning' : 'text-danger';
            
            row.innerHTML = `
                <td><strong>${item.name}</strong></td>
                <td><span class="badge bg-info">${item.building_type}</span></td>
                <td><span class="badge bg-primary">${item.unlock_level}</span></td>
                <td><span class="badge bg-secondary">${item.ingredients_count}</span></td>
                <td><small class="text-muted">${item.ingredients_text}</small></td>
                <td>${item.production_time_min > 0 ? item.production_time_min + '분' : '즉시'}</td>
                <td><strong>${formatNumber(item.sell_price)} 코인</strong></td>
                <td><span class="badge ${efficiencyClass}">${item.efficiency_per_min}</span></td>
                <td><span class="text-success">${formatNumber(item.hourly_profit)}</span></td>
                <td><span class="${profitClass}">${item.profit_margin_percent}%</span></td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    function createCharts(data) {
        // 건물별 생산량 차트
        const buildingCounts = {};
        data.forEach(item => {
            buildingCounts[item.building_type] = (buildingCounts[item.building_type] || 0) + 1;
        });
        
        const buildingCtx = document.getElementById('building-chart').getContext('2d');
        new Chart(buildingCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(buildingCounts),
                datasets: [{
                    data: Object.values(buildingCounts),
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // 효율성 분포 차트
        const efficiencyRanges = {
            '0-10': 0, '10-50': 0, '50-100': 0, '100+': 0
        };
        
        data.forEach(item => {
            const eff = item.efficiency;
            if (eff < 10) efficiencyRanges['0-10']++;
            else if (eff < 50) efficiencyRanges['10-50']++;
            else if (eff < 100) efficiencyRanges['50-100']++;
            else efficiencyRanges['100+']++;
        });
        
        const efficiencyCtx = document.getElementById('efficiency-chart').getContext('2d');
        new Chart(efficiencyCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(efficiencyRanges),
                datasets: [{
                    label: '아이템 수',
                    data: Object.values(efficiencyRanges),
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgb(54, 162, 235)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '아이템 수'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '효율성 범위 (코인/분)'
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}