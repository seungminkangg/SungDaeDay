{% extends "base.html" %}

{% block title %}ë°ì´í„° íƒìƒ‰ - HayDay Dynamic Balancing{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- ì ‘ì„ ìˆ˜ ìˆëŠ” ì‚¬ì´ë“œë°” -->
        <div class="col-md-3 col-lg-2" id="sidebar">
            <div class="d-flex flex-column flex-shrink-0 p-3 bg-light" style="height: 100vh; overflow-y: auto;">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="fs-4">ğŸšœ HayDay</span>
                    <button class="btn btn-sm btn-outline-secondary" id="sidebarToggle">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
                <hr>
                <div class="mb-3">
                    <small class="text-muted">ğŸŒ¾ ë†ì‘ë¬¼ & ê¸°ë³¸ ë°ì´í„°</small>
                </div>
                <div class="list-group mb-3">
                    <button class="list-group-item list-group-item-action active" onclick="loadDataCategory('fields')">
                        <i class="fas fa-seedling me-2"></i>ë°­/ì‘ë¬¼ ë°ì´í„°
                        <span class="badge bg-success float-end" id="fields-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('fruits')">
                        <i class="fas fa-apple-alt me-2"></i>ê³¼ì¼ ë°ì´í„°
                        <span class="badge bg-success float-end" id="fruits-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('fruit_trees')">
                        <i class="fas fa-tree me-2"></i>ê³¼ì¼ë‚˜ë¬´ ë°ì´í„°
                        <span class="badge bg-success float-end" id="fruit-trees-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('animals')">
                        <i class="fas fa-paw me-2"></i>ë™ë¬¼ ë°ì´í„°
                        <span class="badge bg-primary float-end" id="animals-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('levels')">
                        <i class="fas fa-trophy me-2"></i>ë ˆë²¨ ì‹œìŠ¤í…œ
                        <span class="badge bg-primary float-end" id="levels-count">-</span>
                    </button>
                </div>
                
                <div class="mb-2">
                    <small class="text-muted">ğŸ­ ìƒì‚° ê±´ë¬¼</small>
                </div>
                <div class="list-group mb-3">
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('bakery_goods')">
                        <i class="fas fa-bread-slice me-2"></i>ì œê³¼ì 
                        <span class="badge bg-success float-end" id="bakery-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('dairy_goods')">
                        <i class="fas fa-cheese me-2"></i>ìœ ì œí’ˆ ê³µì¥
                        <span class="badge bg-success float-end" id="dairy-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('cafe_goods')">
                        <i class="fas fa-coffee me-2"></i>ì¹´í˜
                        <span class="badge bg-success float-end" id="cafe-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('barbecue_grill_goods')">
                        <i class="fas fa-fire me-2"></i>ë°”ë² í ê·¸ë¦´
                        <span class="badge bg-success float-end" id="bbq-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('juice_press_goods')">
                        <i class="fas fa-glass-whiskey me-2"></i>ì£¼ìŠ¤ í”„ë ˆìŠ¤
                        <span class="badge bg-success float-end" id="juice-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('pie_oven_goods')">
                        <i class="fas fa-cookie me-2"></i>íŒŒì´ ì˜¤ë¸
                        <span class="badge bg-success float-end" id="pie-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('loom_goods')">
                        <i class="fas fa-tshirt me-2"></i>ì§ì¡°ê¸°
                        <span class="badge bg-success float-end" id="loom-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('smelter_goods')">
                        <i class="fas fa-industry me-2"></i>ì œë ¨ì†Œ
                        <span class="badge bg-success float-end" id="smelter-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('sugar_mill_goods')">
                        <i class="fas fa-cube me-2"></i>ì„¤íƒ• ê³µì¥
                        <span class="badge bg-success float-end" id="sugar-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('ice_cream_maker_goods')">
                        <i class="fas fa-ice-cream me-2"></i>ì•„ì´ìŠ¤í¬ë¦¼ ë¨¸ì‹ 
                        <span class="badge bg-success float-end" id="icecream-count">-</span>
                    </button>
                </div>
                
                <div class="mb-2">
                    <small class="text-muted">ğŸ¯ íŠ¹ìˆ˜ ìƒì‚°</small>
                </div>
                <div class="list-group mb-3">
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('fishing_goods')">
                        <i class="fas fa-fish me-2"></i>ë‚šì‹œ ìƒí’ˆ
                        <span class="badge bg-info float-end" id="fishing-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('mine_goods')">
                        <i class="fas fa-gem me-2"></i>ê´‘ì‚° ìƒí’ˆ
                        <span class="badge bg-info float-end" id="mine-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('animal_goods')">
                        <i class="fas fa-egg me-2"></i>ë™ë¬¼ ìƒì‚°í’ˆ
                        <span class="badge bg-info float-end" id="animal-goods-count">-</span>
                    </button>
                </div>
                
                <div class="mb-2">
                    <small class="text-muted">ğŸš› ì£¼ë¬¸ & ë°°ì†¡ ì‹œìŠ¤í…œ</small>
                </div>
                <div class="list-group mb-3">
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('orders')">
                        <i class="fas fa-clipboard-list me-2"></i>ì£¼ë¬¸ ë°ì´í„°
                        <span class="badge bg-warning float-end" id="orders-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('order_tables')">
                        <i class="fas fa-table me-2"></i>ì£¼ë¬¸ í…Œì´ë¸”
                        <span class="badge bg-warning float-end" id="order-tables-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('boats')">
                        <i class="fas fa-ship me-2"></i>ë³´íŠ¸ ì£¼ë¬¸
                        <span class="badge bg-info float-end" id="boats-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('train')">
                        <i class="fas fa-train me-2"></i>ê¸°ì°¨ ì£¼ë¬¸
                        <span class="badge bg-info float-end" id="train-count">-</span>
                    </button>
                </div>

                <div class="mb-2">
                    <small class="text-muted">ğŸ—ï¸ ê±´ë¬¼ & ì‹œì„¤ ì‹œìŠ¤í…œ</small>
                </div>
                <div class="list-group mb-3">
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('processing_buildings')">
                        <i class="fas fa-cogs me-2"></i>ìƒì‚° ê±´ë¬¼ (ìŠ¬ë¡¯í¬í•¨)
                        <span class="badge bg-secondary float-end" id="processing-buildings-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('production_buildings_goods')">
                        <i class="fas fa-industry me-2"></i>ê±´ë¬¼ë³„ ìƒì‚°í’ˆ
                        <span class="badge bg-secondary float-end" id="production-buildings-goods-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('exp_levels')">
                        <i class="fas fa-chart-line me-2"></i>ê²½í—˜ì¹˜ & ë ˆë²¨ì—…
                        <span class="badge bg-success float-end" id="exp-levels-count">-</span>
                    </button>
                </div>
                
                <div class="mb-2">
                    <small class="text-muted">ğŸ“Š í†µí•© ë³´ê¸° & ì •ì±…</small>
                </div>
                <div class="list-group">
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('all_goods')">
                        <i class="fas fa-boxes me-2"></i>ëª¨ë“  ìƒì‚°í’ˆ
                        <span class="badge bg-warning float-end">í†µí•©</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('balancing')">
                        <i class="fas fa-balance-scale me-2"></i>ë°¸ëŸ°ì‹± ì •ì±…
                        <span class="badge bg-info float-end">ì •ì±…</span>
                    </button>
                </div>
                
                <!-- Streamlit ì—°ë™ ìƒíƒœ -->
                <div class="mt-3">
                    <small class="text-muted">ì—°ë™ ìƒíƒœ</small>
                    <div id="connectionStatus" class="badge bg-secondary">í™•ì¸ ì¤‘...</div>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <div class="col-md-9 col-lg-10" id="mainContent">
            <div class="container-fluid py-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="d-flex align-items-center">
                        <button class="btn btn-outline-secondary me-3" onclick="toggleSidebar()">
                            <i class="fas fa-bars"></i>
                        </button>
                        <h1 class="h2 mb-0">ğŸ“Š HayDay ì›ë³¸ ë°ì´í„° íƒìƒ‰</h1>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary" onclick="openStreamlit()">
                            <i class="fas fa-external-link-alt me-2"></i>Streamlit ì—´ê¸°
                        </button>
                    </div>
                </div>

                <!-- ê²€ìƒ‰ -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">ì–¸ì–´ ì„ íƒ</label>
                        <select class="form-select" id="language-select" onchange="changeLanguage()">
                            <option value="en">English (ì˜ì–´)</option>
                            <option value="kr">í•œêµ­ì–´ (Korean)</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">ê²€ìƒ‰</label>
                        <input type="text" class="form-control" id="search-input" placeholder="ë°ì´í„° ê²€ìƒ‰...">
                    </div>
                </div>

                <!-- ë°ì´í„° í‘œì‹œ ì˜ì—­ -->
                <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0" id="data-title">
                    <i class="fas fa-table me-2"></i>ë™ë¬¼ ë°ì´í„°
                </h5>
                <div>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-1"></i>ìƒˆë¡œê³ ì¹¨
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="toggleRawView()">
                        <i class="fas fa-code me-1"></i>ì›ë³¸ ë³´ê¸°
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="resetColumnOrder()">
                        <i class="fas fa-undo me-1"></i>ì»¬ëŸ¼ ìˆœì„œ ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="data-loading" class="text-center py-4">
                    <div class="loading"></div>
                    <p class="mt-2">ë°ì´í„° ë¡œë”© ì¤‘...</p>
                </div>
                
                <div id="data-content" style="display: none;">
                    <!-- ë°ì´í„° ìš”ì•½ -->
                    <div class="row mb-3" id="data-summary">
                        <!-- ìš”ì•½ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                    
                    <!-- ë°ì´í„° í…Œì´ë¸” (Tabulator) -->
                    <div id="data-table" style="min-height: 400px;"></div>
                    
                    <!-- í˜ì´ì§€ë„¤ì´ì…˜ì€ Tabulatorê°€ ìë™ìœ¼ë¡œ ì²˜ë¦¬ -->
                </div>
                
                <div id="raw-data-view" style="display: none;">
                    <pre><code id="raw-data-content" class="language-json"></code></pre>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentData = [];
    let currentCategory = 'animals';
    let currentPage = 1;
    let itemsPerPage = 20;
    let isRawView = false;
    let currentLanguage = 'en';
    
    // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    document.addEventListener('DOMContentLoaded', function() {
        loadDataCategory('fields');
        
        // ê²€ìƒ‰ ì…ë ¥ ì´ë²¤íŠ¸
        document.getElementById('search-input').addEventListener('input', function() {
            filterData();
        });
    });
    
    // ë°ì´í„° ì¹´í…Œê³ ë¦¬ ë¡œë“œ
    function loadDataCategory(category, element) {
        currentCategory = category;
        currentPage = 1;
        
        // í™œì„± ë²„íŠ¼ ë³€ê²½
        document.querySelectorAll('.list-group-item').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // elementê°€ ì „ë‹¬ë˜ë©´ í•´ë‹¹ ìš”ì†Œë¥¼ í™œì„±í™”, ì•„ë‹ˆë©´ í˜„ì¬ í´ë¦­ëœ ìš”ì†Œë¥¼ ì°¾ìŒ
        const activeBtn = element || document.querySelector(`[onclick*="${category}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }
        
        // ë¡œë”© í‘œì‹œ
        document.getElementById('data-loading').style.display = 'block';
        document.getElementById('data-content').style.display = 'none';
        document.getElementById('raw-data-view').style.display = 'none';
        
        let apiUrl = '';
        let title = '';
        
        switch(category) {
            // ë†ì‘ë¬¼ & ê¸°ë³¸ ë°ì´í„°
            case 'fields':
                apiUrl = '/api/csv-data/fields';
                title = 'ë°­/ì‘ë¬¼ ë°ì´í„°';
                break;
            case 'fruits':
                apiUrl = '/api/csv-data/fruits';
                title = 'ê³¼ì¼ ë°ì´í„°';
                break;
            case 'fruit_trees':
                apiUrl = '/api/csv-data/fruit_trees';
                title = 'ê³¼ì¼ë‚˜ë¬´ ë°ì´í„°';
                break;
            case 'animals':
                apiUrl = '/api/csv-data/Animals';
                title = 'ë™ë¬¼ ë°ì´í„°';
                break;
            case 'levels':
                apiUrl = '/api/csv-data/Levels';
                title = 'ë ˆë²¨ ì‹œìŠ¤í…œ';
                break;
            
            // ìƒì‚° ê±´ë¬¼ë³„ ìƒí’ˆ
            case 'bakery_goods':
                apiUrl = '/api/csv-data/bakery_goods';
                title = 'ì œê³¼ì  ìƒí’ˆ';
                break;
            case 'dairy_goods':
                apiUrl = '/api/csv-data/dairy_goods';
                title = 'ìœ ì œí’ˆ ê³µì¥';
                break;
            case 'cafe_goods':
                apiUrl = '/api/csv-data/cafe_goods';
                title = 'ì¹´í˜ ìƒí’ˆ';
                break;
            case 'barbecue_grill_goods':
                apiUrl = '/api/csv-data/barbecue_grill_goods';
                title = 'ë°”ë² í ê·¸ë¦´';
                break;
            case 'juice_press_goods':
                apiUrl = '/api/csv-data/juice_press_goods';
                title = 'ì£¼ìŠ¤ í”„ë ˆìŠ¤';
                break;
            case 'pie_oven_goods':
                apiUrl = '/api/csv-data/pie_oven_goods';
                title = 'íŒŒì´ ì˜¤ë¸';
                break;
            case 'loom_goods':
                apiUrl = '/api/csv-data/loom_goods';
                title = 'ì§ì¡°ê¸°';
                break;
            case 'smelter_goods':
                apiUrl = '/api/csv-data/smelter_goods';
                title = 'ì œë ¨ì†Œ';
                break;
            case 'sugar_mill_goods':
                apiUrl = '/api/csv-data/sugar_mill_goods';
                title = 'ì„¤íƒ• ê³µì¥';
                break;
            case 'ice_cream_maker_goods':
                apiUrl = '/api/csv-data/ice_cream_maker_goods';
                title = 'ì•„ì´ìŠ¤í¬ë¦¼ ë¨¸ì‹ ';
                break;
            
            // íŠ¹ìˆ˜ ìƒì‚°
            case 'fishing_goods':
                apiUrl = '/api/csv-data/fishing_goods';
                title = 'ë‚šì‹œ ìƒí’ˆ';
                break;
            case 'mine_goods':
                apiUrl = '/api/csv-data/mine_goods';
                title = 'ê´‘ì‚° ìƒí’ˆ';
                break;
            case 'animal_goods':
                apiUrl = '/api/csv-data/animal_goods';
                title = 'ë™ë¬¼ ìƒì‚°í’ˆ';
                break;
            
            // ì£¼ë¬¸ & ë°°ì†¡ ì‹œìŠ¤í…œ
            case 'orders':
                apiUrl = '/api/csv-data/orders';
                title = 'ì£¼ë¬¸ ë°ì´í„°';
                break;
            case 'order_tables':
                apiUrl = '/api/csv-data/order_tables';
                title = 'ì£¼ë¬¸ í…Œì´ë¸”';
                break;
            case 'boats':
                apiUrl = '/api/csv-data/boats';
                title = 'ë³´íŠ¸ ì£¼ë¬¸';
                break;
            case 'train':
                apiUrl = '/api/csv-data/train';
                title = 'ê¸°ì°¨ ì£¼ë¬¸';
                break;
            
            // ê±´ë¬¼ & ì‹œì„¤ ì‹œìŠ¤í…œ
            case 'processing_buildings':
                apiUrl = '/api/csv-data/processing_buildings';
                title = 'ìƒì‚° ê±´ë¬¼ (ìŠ¬ë¡¯í¬í•¨)';
                break;
            case 'production_buildings_goods':
                apiUrl = '/api/csv-data/production_buildings_goods';
                title = 'ê±´ë¬¼ë³„ ìƒì‚°í’ˆ';
                break;
            case 'exp_levels':
                apiUrl = '/api/csv-data/exp_levels';
                title = 'ê²½í—˜ì¹˜ & ë ˆë²¨ì—…';
                break;
            
            // í†µí•© ë³´ê¸°
            case 'all_goods':
                apiUrl = '/api/production-chains';
                title = 'ëª¨ë“  ìƒì‚°í’ˆ (í†µí•©)';
                break;
            case 'balancing':
                apiUrl = '/api/balancing-policies';
                title = 'ë°¸ëŸ°ì‹± ì •ì±…';
                break;
        }
        
        document.getElementById('data-title').innerHTML = `<i class="fas fa-table me-2"></i>${title}`;
        
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('data-loading').innerHTML = 
                        `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                
                // ë°¸ëŸ°ì‹± ì •ì±…ì˜ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
                if (category === 'balancing') {
                    currentData = [];
                    for (const [key, policies] of Object.entries(data)) {
                        policies.forEach(policy => {
                            currentData.push({ ...policy, _category: key });
                        });
                    }
                } else {
                    currentData = Array.isArray(data) ? data : [data];
                }
                
                displayData();
                document.getElementById('data-loading').style.display = 'none';
                document.getElementById('data-content').style.display = 'block';
            })
            .catch(error => {
                document.getElementById('data-loading').innerHTML = 
                    `<div class="alert alert-danger">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}</div>`;
            });
    }
    
    // ë°ì´í„° í‘œì‹œ
    function displayData() {
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        let pageData = currentData.slice(startIndex, endIndex);
        
        // ë¡œì»¬ë¼ì´ì œì´ì…˜ ì ìš©
        const localizedData = applyLocalization(currentData);
        
        // ìš”ì•½ ì •ë³´
        updateDataSummary();
        
        // í…Œì´ë¸” ìƒì„± (ì „ì²´ ë°ì´í„°ë¡œ - Tabulatorê°€ í˜ì´ì§€ë„¤ì´ì…˜ ì²˜ë¦¬)
        createDataTable(localizedData);
    }
    
    // ë°ì´í„° ìš”ì•½ ì—…ë°ì´íŠ¸
    function updateDataSummary() {
        const summary = document.getElementById('data-summary');
        summary.innerHTML = `
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h5>${formatNumber(currentData.length)}</h5>
                        <small>ì´ ë ˆì½”ë“œ ìˆ˜</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h5>${currentData.length > 0 ? Object.keys(currentData[0]).length : 0}</h5>
                        <small>ì»¬ëŸ¼ ìˆ˜</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h5>${currentPage}</h5>
                        <small>í˜„ì¬ í˜ì´ì§€</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h5>${Math.ceil(currentData.length / itemsPerPage)}</h5>
                        <small>ì´ í˜ì´ì§€</small>
                    </div>
                </div>
            </div>
        `;
    }
    
    // ì»¬ëŸ¼ëª… ë²ˆì—­
    function translateColumnName(columnName) {
        const translations = {
            'Name': 'ì´ë¦„',
            'ToolIconExportName': 'ì•„ì´ì½˜',
            'TID': 'ID',
            'TimeMin': 'ìƒì‚°ì‹œê°„(ë¶„)',
            'OrderPrice': 'ì£¼ë¬¸ê°€ê²©',
            'OrderExp': 'ì£¼ë¬¸ê²½í—˜ì¹˜',
            'ExpCollect': 'ìˆ˜ì§‘ê²½í—˜ì¹˜',
            'OrderValue': 'ì£¼ë¬¸ê°€ì¹˜',
            'BoatOrderValue': 'ë³´íŠ¸ê°€ì¹˜',
            'ProcessingBuilding': 'ìƒì‚°ê±´ë¬¼',
            'UnlockLevel': 'í•´ê¸ˆë ˆë²¨',
            'Difficulty': 'ë‚œì´ë„',
            'RequirementAmount': 'í•„ìš”ìˆ˜ëŸ‰',
            'Requirement': 'í•„ìš”ì¬ë£Œ',
            'unlock_level': 'í•´ê¸ˆë ˆë²¨',
            'level': 'ë ˆë²¨',
            'sell_price': 'íŒë§¤ê°€ê²©',
            'efficiency_per_min': 'ë¶„ë‹¹íš¨ìœ¨',
            'building_type': 'ê±´ë¬¼íƒ€ì…',
            'ingredients_text': 'í•„ìš”ì¬ë£Œ'
        };
        return translations[columnName] || columnName;
    }
    
    // ì „ì—­ Tabulator ì¸ìŠ¤í„´ìŠ¤
    let currentTable = null;
    
    // ë°ì´í„° í…Œì´ë¸” ìƒì„± (Tabulator ì‚¬ìš©)
    function createDataTable(data) {
        if (data.length === 0) {
            document.getElementById('data-table').innerHTML = '<div class="text-center p-4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }
        
        // ê¸°ì¡´ í…Œì´ë¸” ì œê±°
        if (currentTable) {
            currentTable.destroy();
        }
        
        // ì»¬ëŸ¼ ì •ì˜ ìƒì„±
        let headers = Object.keys(data[0]);
        
        // ì €ì¥ëœ ì»¬ëŸ¼ ìˆœì„œ ë¶ˆëŸ¬ì˜¤ê¸°
        const savedOrder = localStorage.getItem(`column_order_${currentCategory}`);
        if (savedOrder) {
            try {
                const parsedOrder = JSON.parse(savedOrder);
                // ì €ì¥ëœ ìˆœì„œê°€ ìœ íš¨í•œì§€ í™•ì¸
                if (parsedOrder.every(field => headers.includes(field))) {
                    // ì €ì¥ëœ ìˆœì„œì— ì—†ëŠ” ìƒˆ ì»¬ëŸ¼ë“¤ì„ ë’¤ì— ì¶”ê°€
                    const newHeaders = headers.filter(h => !parsedOrder.includes(h));
                    headers = [...parsedOrder, ...newHeaders];
                }
            } catch (e) {
                console.warn('ì €ì¥ëœ ì»¬ëŸ¼ ìˆœì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', e);
            }
        }
        
        const columns = headers.map(header => ({
            title: translateColumnName(header),
            field: header,
            sorter: "string",
            headerFilter: "input",
            headerFilterPlaceholder: "ê²€ìƒ‰...",
            formatter: function(cell, formatterParams) {
                let value = cell.getValue();
                
                // ê°’ í¬ë§·íŒ…
                if (typeof value === 'number' && value > 1000) {
                    value = formatNumber(value);
                } else if (typeof value === 'object' && value !== null) {
                    value = JSON.stringify(value);
                } else if (value === null || value === undefined) {
                    value = '<span class="text-muted">-</span>';
                }
                
                return value;
            }
        }));
        
        // Tabulator í…Œì´ë¸” ìƒì„± - ê°œì„ ëœ ìŠ¤íƒ€ì¼ë§
        currentTable = new Tabulator("#data-table", {
            data: data,
            columns: columns,
            layout: "fitDataTable", // ë°ì´í„°ì— ë§ê²Œ ìë™ ì¡°ì •
            responsiveLayout: "collapse",
            responsiveLayoutCollapseStartOpen: false,
            pagination: "local",
            paginationSize: itemsPerPage,
            paginationSizeSelector: [10, 25, 50, 100],
            movableColumns: true, // ì»¬ëŸ¼ ë“œë˜ê·¸ì•¤ë“œë¡­ í™œì„±í™”
            resizableColumns: true,
            headerFilterLiveFilterDelay: 300,
            rowHeight: 45, // í–‰ ë†’ì´ ì¦ê°€
            minHeight: 500, // ìµœì†Œ ë†’ì´ ì„¤ì •
            locale: "ko",
            langs: {
                "ko": {
                    "pagination": {
                        "page_size": "í˜ì´ì§€ë‹¹ í–‰ ìˆ˜",
                        "first": "ì²« í˜ì´ì§€",
                        "first_title": "ì²« í˜ì´ì§€ë¡œ ì´ë™",
                        "last": "ë§ˆì§€ë§‰",
                        "last_title": "ë§ˆì§€ë§‰ í˜ì´ì§€ë¡œ ì´ë™",
                        "prev": "ì´ì „",
                        "prev_title": "ì´ì „ í˜ì´ì§€ë¡œ ì´ë™",
                        "next": "ë‹¤ìŒ",
                        "next_title": "ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™"
                    }
                }
            }
        });
        
        // ì»¬ëŸ¼ ìˆœì„œ ë³€ê²½ ì‹œ ì„¤ì • ì €ì¥
        currentTable.on("columnMoved", function(column, columns){
            const columnOrder = columns.map(col => col.getField());
            localStorage.setItem(`column_order_${currentCategory}`, JSON.stringify(columnOrder));
            showToast('ì»¬ëŸ¼ ìˆœì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        });
    }
    
    // ì»¬ëŸ¼ ìˆœì„œ ì´ˆê¸°í™”
    function resetColumnOrder() {
        if (confirm('ì»¬ëŸ¼ ìˆœì„œë¥¼ ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            localStorage.removeItem(`column_order_${currentCategory}`);
            showToast('ì»¬ëŸ¼ ìˆœì„œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            // í˜„ì¬ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
            displayData();
        }
    }
    
    // í˜ì´ì§€ë„¤ì´ì…˜ ìƒì„±
    function createPagination() {
        const totalPages = Math.ceil(currentData.length / itemsPerPage);
        const pagination = document.getElementById('pagination');
        
        if (totalPages <= 1) {
            document.getElementById('pagination-nav').style.display = 'none';
            return;
        }
        
        document.getElementById('pagination-nav').style.display = 'block';
        
        let paginationHTML = '';
        
        // ì´ì „ ë²„íŠ¼
        paginationHTML += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <button class="page-link" onclick="changePage(${currentPage - 1})">ì´ì „</button>
            </li>
        `;
        
        // í˜ì´ì§€ ë²ˆí˜¸
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <button class="page-link" onclick="changePage(${i})">${i}</button>
                </li>
            `;
        }
        
        // ë‹¤ìŒ ë²„íŠ¼
        paginationHTML += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <button class="page-link" onclick="changePage(${currentPage + 1})">ë‹¤ìŒ</button>
            </li>
        `;
        
        pagination.innerHTML = paginationHTML;
    }
    
    // í˜ì´ì§€ ë³€ê²½
    function changePage(page) {
        const totalPages = Math.ceil(currentData.length / itemsPerPage);
        if (page < 1 || page > totalPages) return;
        
        currentPage = page;
        displayData();
    }
    
    // ë°ì´í„° í•„í„°ë§
    function filterData() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        
        if (searchTerm === '') {
            displayData();
            return;
        }
        
        const filteredData = currentData.filter(row => {
            return Object.values(row).some(value => 
                String(value).toLowerCase().includes(searchTerm)
            );
        });
        
        // ì„ì‹œë¡œ í˜„ì¬ ë°ì´í„°ë¥¼ í•„í„°ëœ ë°ì´í„°ë¡œ êµì²´
        const originalData = currentData;
        currentData = filteredData;
        currentPage = 1;
        displayData();
        currentData = originalData;
    }
    
    // ì›ë³¸ ë°ì´í„° ë³´ê¸° í† ê¸€
    function toggleRawView() {
        isRawView = !isRawView;
        
        if (isRawView) {
            document.getElementById('data-content').style.display = 'none';
            document.getElementById('raw-data-view').style.display = 'block';
            document.getElementById('raw-data-content').textContent = JSON.stringify(currentData, null, 2);
        } else {
            document.getElementById('data-content').style.display = 'block';
            document.getElementById('raw-data-view').style.display = 'none';
        }
    }
    
    // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
    function refreshData() {
        loadDataCategory(currentCategory);
    }
    
    // í˜„ì¬ ë°ì´í„° ë‚´ë³´ë‚´ê¸°
    function exportCurrentData() {
        const dataStr = JSON.stringify(currentData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `hayday_${currentCategory}_data.json`;
        link.click();
        
        showToast('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!', 'success');
    }
    
    // ì–¸ì–´ ë³€ê²½
    function changeLanguage() {
        currentLanguage = document.getElementById('language-select').value;
        // í˜„ì¬ ì¹´í…Œê³ ë¦¬ ë‹¤ì‹œ ë¡œë“œ
        loadDataCategory(currentCategory);
    }
    
    // ë°ì´í„°ì— ë¡œì»¬ë¼ì´ì œì´ì…˜ ì ìš©
    function applyLocalization(data) {
        if (!data || data.length === 0) return data;
        
        return data.map(item => {
            let localizedItem = { ...item };
            
            // ëª¨ë“  TID ê´€ë ¨ ì»¬ëŸ¼ ë¡œì»¬ë¼ì´ì œì´ì…˜
            for (const key in item) {
                if (key.endsWith('_KR') || key.endsWith('_EN')) {
                    const baseKey = key.replace('_KR', '').replace('_EN', '');
                    
                    if (currentLanguage === 'kr' && key.endsWith('_KR') && item[key]) {
                        localizedItem[baseKey] = item[key];
                        // ëŒ€ì†Œë¬¸ì ë³€í˜•ë„ ì²˜ë¦¬
                        localizedItem[baseKey.toLowerCase()] = item[key];
                        if (baseKey === 'Name') {
                            localizedItem.name = item[key];
                        }
                    } else if (currentLanguage === 'en' && key.endsWith('_EN') && item[key]) {
                        localizedItem[baseKey] = item[key];
                        // ëŒ€ì†Œë¬¸ì ë³€í˜•ë„ ì²˜ë¦¬
                        localizedItem[baseKey.toLowerCase()] = item[key];
                        if (baseKey === 'Name') {
                            localizedItem.name = item[key];
                        }
                    }
                }
            }
            
            // Feed(ì‚¬ë£Œ) ì»¬ëŸ¼ ë¡œì»¬ë¼ì´ì œì´ì…˜ (ìˆëŠ” ê²½ìš°)
            if (item.feed && currentLanguage === 'kr') {
                // ì‚¬ë£Œ ì´ë¦„ë„ ë²ˆì—­ ê°€ëŠ¥í•˜ë©´ ì ìš©
                localizedItem.feed = translateFeedName(item.feed);
            }
            
            // Good(ìƒì‚°í’ˆ) ì»¬ëŸ¼ ë¡œì»¬ë¼ì´ì œì´ì…˜ (ìˆëŠ” ê²½ìš°)
            if (item.good && currentLanguage === 'kr') {
                localizedItem.good = translateGoodName(item.good);
            }
            
            return localizedItem;
        });
    }
    
    // ì‚¬ë£Œ ì´ë¦„ ë²ˆì—­
    function translateFeedName(feedName) {
        const feedTranslations = {
            'Chicken Food': 'ë‹­ ì‚¬ë£Œ',
            'Cow Food': 'ì†Œ ì‚¬ë£Œ',
            'Sheep Food': 'ì–‘ ì‚¬ë£Œ',
            'Pig Food': 'ë¼ì§€ ì‚¬ë£Œ',
            'Goat Food': 'ì—¼ì†Œ ì‚¬ë£Œ'
        };
        return feedTranslations[feedName] || feedName;
    }
    
    // ìƒì‚°í’ˆ ì´ë¦„ ë²ˆì—­
    function translateGoodName(goodName) {
        const goodTranslations = {
            'Egg': 'ë‹¬ê±€',
            'Milk': 'ìš°ìœ ',
            'Wool': 'ì–‘ëª¨',
            'Bacon': 'ë² ì´ì»¨',
            'Goat Milk': 'ì—¼ì†Œ ìš°ìœ '
        };
        return goodTranslations[goodName] || goodName;
    }

    // ì‚¬ì´ë“œë°” í† ê¸€ ê¸°ëŠ¥
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const toggleBtn = document.getElementById('sidebarToggle');
        const icon = toggleBtn.querySelector('i');
        
        sidebar.classList.toggle('collapsed');
        
        if (sidebar.classList.contains('collapsed')) {
            // ì ‘í˜ - ì‚¬ì´ë“œë°” ìˆ¨ê¸°ê³  ë©”ì¸ ì½˜í…ì¸  ì „ì²´ ë„ˆë¹„ ì‚¬ìš©
            sidebar.style.display = 'none';
            mainContent.className = 'col-12';
            icon.className = 'fas fa-chevron-right';
        } else {
            // í¼ì¹¨ - ì‚¬ì´ë“œë°” ë³´ì´ê³  ì›ë˜ Grid ë ˆì´ì•„ì›ƒ ë³µì›
            sidebar.style.display = 'block';
            mainContent.className = 'col-md-9 col-lg-10';
            icon.className = 'fas fa-chevron-left';
        }
        
        // í…Œì´ë¸” ë¦¬ì‚¬ì´ì¦ˆ íŠ¸ë¦¬ê±° (Tabulator í…Œì´ë¸”ì´ ìƒˆ ë„ˆë¹„ì— ë§ê²Œ ì¡°ì •ë˜ë„ë¡)
        if (currentTable) {
            setTimeout(() => {
                currentTable.redraw(true);
            }, 300);
        }
    }

    // Streamlit ì—´ê¸°
    function openStreamlit() {
        window.open('http://localhost:8501', '_blank');
    }

    // Streamlit ì—°ê²° ìƒíƒœ í™•ì¸
    function updateConnectionStatus() {
        fetch('/api/streamlit-sync')
            .then(response => response.json())
            .then(data => {
                const status = document.getElementById('connectionStatus');
                if (data.streamlit_status === 'online') {
                    status.className = 'badge bg-success';
                    status.textContent = 'ğŸŸ¢ Streamlit ì—°ê²°ë¨';
                } else {
                    status.className = 'badge bg-warning';
                    status.textContent = 'ğŸŸ¡ Streamlit ì˜¤í”„ë¼ì¸';
                }
            })
            .catch(error => {
                const status = document.getElementById('connectionStatus');
                status.className = 'badge bg-danger';
                status.textContent = 'ğŸ”´ ì—°ê²° ì‹¤íŒ¨';
            });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¶”ê°€ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        // ì‚¬ì´ë“œë°” í† ê¸€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        if (document.getElementById('sidebarToggle')) {
            document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
        }
        
        // ì—°ê²° ìƒíƒœ í™•ì¸
        updateConnectionStatus();
        
        // ì •ê¸°ì ìœ¼ë¡œ ì—°ê²° ìƒíƒœ í™•ì¸
        setInterval(updateConnectionStatus, 30000); // 30ì´ˆë§ˆë‹¤ í™•ì¸
    });
</script>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
#sidebar {
    transition: all 0.3s ease;
    position: relative;
}

#sidebar.collapsed {
    display: none;
}

#mainContent {
    transition: all 0.3s ease;
    padding-left: 15px;
    padding-right: 15px;
}

.list-group-item {
    border: none;
    margin-bottom: 2px;
    border-radius: 8px;
}

.list-group-item:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
}

.list-group-item.active {
    background-color: #2E7D32;
    color: white;
}

.list-group-item.active:hover {
    background-color: #1B5E20;
}
/* Tabulator í…Œì´ë¸” ìŠ¤íƒ€ì¼ë§ ê°œì„  */
.tabulator {
    font-size: 14px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
}

.tabulator .tabulator-header {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
}

.tabulator .tabulator-header .tabulator-col {
    background-color: #f8f9fa;
    border-right: 1px solid #dee2e6;
    padding: 12px 8px;
    font-weight: 600;
    color: #495057;
}

.tabulator .tabulator-header .tabulator-col:hover {
    background-color: #e9ecef;
}

.tabulator-row {
    border-bottom: 1px solid #f1f3f4;
    min-height: 45px;
}

.tabulator-row:hover {
    background-color: #f8f9fa;
}

.tabulator-row:nth-child(even) {
    background-color: #fafbfc;
}

.tabulator-cell {
    padding: 12px 8px;
    border-right: 1px solid #f1f3f4;
    vertical-align: middle;
    line-height: 1.4;
}

.tabulator-pagination {
    padding: 15px;
    background-color: #f8f9fa;
    border-top: 1px solid #dee2e6;
}

.tabulator-page {
    margin: 0 3px;
    padding: 8px 12px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    background-color: white;
}

.tabulator-page.active {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
}

.tabulator-page:hover {
    background-color: #e9ecef;
}

/* í—¤ë” í•„í„° ìŠ¤íƒ€ì¼ë§ */
.tabulator-header-filter input {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 12px;
}

/* ë°˜ì‘í˜• ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ë§ */
.tabulator-responsive-collapse-toggle {
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    font-size: 12px;
}

/* ë°ì´í„°ê°€ ì—†ì„ ë•Œ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ë§ */
.tabulator-placeholder {
    padding: 40px;
    text-align: center;
    color: #6c757d;
    font-style: italic;
}
</style>
{% endblock %}