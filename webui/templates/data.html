{% extends "base.html" %}

{% block title %}데이터 탐색 - HayDay Dynamic Balancing{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- 접을 수 있는 사이드바 -->
        <div class="col-md-3 col-lg-2" id="sidebar">
            <div class="d-flex flex-column flex-shrink-0 p-3 bg-light" style="height: 100vh; overflow-y: auto;">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="fs-4">🚜 HayDay</span>
                    <button class="btn btn-sm btn-outline-secondary" id="sidebarToggle">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
                <hr>
                <div class="mb-3">
                    <small class="text-muted">🌾 농작물 & 기본 데이터</small>
                </div>
                <div class="list-group mb-3">
                    <button class="list-group-item list-group-item-action active" onclick="loadDataCategory('fields')">
                        <i class="fas fa-seedling me-2"></i>밭/작물 데이터
                        <span class="badge bg-success float-end" id="fields-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('fruits')">
                        <i class="fas fa-apple-alt me-2"></i>과일 데이터
                        <span class="badge bg-success float-end" id="fruits-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('fruit_trees')">
                        <i class="fas fa-tree me-2"></i>과일나무 데이터
                        <span class="badge bg-success float-end" id="fruit-trees-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('animals')">
                        <i class="fas fa-paw me-2"></i>동물 데이터
                        <span class="badge bg-primary float-end" id="animals-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('levels')">
                        <i class="fas fa-trophy me-2"></i>레벨 시스템
                        <span class="badge bg-primary float-end" id="levels-count">-</span>
                    </button>
                </div>
                
                <div class="mb-2">
                    <small class="text-muted">🏭 생산 건물</small>
                </div>
                <div class="list-group mb-3">
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('bakery_goods')">
                        <i class="fas fa-bread-slice me-2"></i>제과점
                        <span class="badge bg-success float-end" id="bakery-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('dairy_goods')">
                        <i class="fas fa-cheese me-2"></i>유제품 공장
                        <span class="badge bg-success float-end" id="dairy-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('cafe_goods')">
                        <i class="fas fa-coffee me-2"></i>카페
                        <span class="badge bg-success float-end" id="cafe-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('barbecue_grill_goods')">
                        <i class="fas fa-fire me-2"></i>바베큐 그릴
                        <span class="badge bg-success float-end" id="bbq-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('juice_press_goods')">
                        <i class="fas fa-glass-whiskey me-2"></i>주스 프레스
                        <span class="badge bg-success float-end" id="juice-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('pie_oven_goods')">
                        <i class="fas fa-cookie me-2"></i>파이 오븐
                        <span class="badge bg-success float-end" id="pie-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('loom_goods')">
                        <i class="fas fa-tshirt me-2"></i>직조기
                        <span class="badge bg-success float-end" id="loom-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('smelter_goods')">
                        <i class="fas fa-industry me-2"></i>제련소
                        <span class="badge bg-success float-end" id="smelter-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('sugar_mill_goods')">
                        <i class="fas fa-cube me-2"></i>설탕 공장
                        <span class="badge bg-success float-end" id="sugar-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('ice_cream_maker_goods')">
                        <i class="fas fa-ice-cream me-2"></i>아이스크림 머신
                        <span class="badge bg-success float-end" id="icecream-count">-</span>
                    </button>
                </div>
                
                <div class="mb-2">
                    <small class="text-muted">🎯 특수 생산</small>
                </div>
                <div class="list-group mb-3">
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('fishing_goods')">
                        <i class="fas fa-fish me-2"></i>낚시 상품
                        <span class="badge bg-info float-end" id="fishing-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('mine_goods')">
                        <i class="fas fa-gem me-2"></i>광산 상품
                        <span class="badge bg-info float-end" id="mine-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('animal_goods')">
                        <i class="fas fa-egg me-2"></i>동물 생산품
                        <span class="badge bg-info float-end" id="animal-goods-count">-</span>
                    </button>
                </div>
                
                <div class="mb-2">
                    <small class="text-muted">🚛 주문 & 배송 시스템</small>
                </div>
                <div class="list-group mb-3">
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('orders')">
                        <i class="fas fa-clipboard-list me-2"></i>주문 데이터
                        <span class="badge bg-warning float-end" id="orders-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('order_tables')">
                        <i class="fas fa-table me-2"></i>주문 테이블
                        <span class="badge bg-warning float-end" id="order-tables-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('boats')">
                        <i class="fas fa-ship me-2"></i>보트 주문
                        <span class="badge bg-info float-end" id="boats-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('train')">
                        <i class="fas fa-train me-2"></i>기차 주문
                        <span class="badge bg-info float-end" id="train-count">-</span>
                    </button>
                </div>

                <div class="mb-2">
                    <small class="text-muted">🏗️ 건물 & 시설 시스템</small>
                </div>
                <div class="list-group mb-3">
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('processing_buildings')">
                        <i class="fas fa-cogs me-2"></i>생산 건물 (슬롯포함)
                        <span class="badge bg-secondary float-end" id="processing-buildings-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('production_buildings_goods')">
                        <i class="fas fa-industry me-2"></i>건물별 생산품
                        <span class="badge bg-secondary float-end" id="production-buildings-goods-count">-</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('exp_levels')">
                        <i class="fas fa-chart-line me-2"></i>경험치 & 레벨업
                        <span class="badge bg-success float-end" id="exp-levels-count">-</span>
                    </button>
                </div>
                
                <div class="mb-2">
                    <small class="text-muted">📊 통합 보기 & 정책</small>
                </div>
                <div class="list-group">
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('all_goods')">
                        <i class="fas fa-boxes me-2"></i>모든 생산품
                        <span class="badge bg-warning float-end">통합</span>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="loadDataCategory('balancing')">
                        <i class="fas fa-balance-scale me-2"></i>밸런싱 정책
                        <span class="badge bg-info float-end">정책</span>
                    </button>
                </div>
                
                <!-- Streamlit 연동 상태 -->
                <div class="mt-3">
                    <small class="text-muted">연동 상태</small>
                    <div id="connectionStatus" class="badge bg-secondary">확인 중...</div>
                </div>
            </div>
        </div>

        <!-- 메인 콘텐츠 -->
        <div class="col-md-9 col-lg-10" id="mainContent">
            <div class="container-fluid py-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="d-flex align-items-center">
                        <button class="btn btn-outline-secondary me-3" onclick="toggleSidebar()">
                            <i class="fas fa-bars"></i>
                        </button>
                        <h1 class="h2 mb-0">📊 HayDay 원본 데이터 탐색</h1>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary" onclick="openStreamlit()">
                            <i class="fas fa-external-link-alt me-2"></i>Streamlit 열기
                        </button>
                    </div>
                </div>

                <!-- 검색 -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">언어 선택</label>
                        <select class="form-select" id="language-select" onchange="changeLanguage()">
                            <option value="en">English (영어)</option>
                            <option value="kr">한국어 (Korean)</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">검색</label>
                        <input type="text" class="form-control" id="search-input" placeholder="데이터 검색...">
                    </div>
                </div>

                <!-- 데이터 표시 영역 -->
                <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0" id="data-title">
                    <i class="fas fa-table me-2"></i>동물 데이터
                </h5>
                <div>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-1"></i>새로고침
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="toggleRawView()">
                        <i class="fas fa-code me-1"></i>원본 보기
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="resetColumnOrder()">
                        <i class="fas fa-undo me-1"></i>컬럼 순서 초기화
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="data-loading" class="text-center py-4">
                    <div class="loading"></div>
                    <p class="mt-2">데이터 로딩 중...</p>
                </div>
                
                <div id="data-content" style="display: none;">
                    <!-- 데이터 요약 -->
                    <div class="row mb-3" id="data-summary">
                        <!-- 요약 정보가 여기에 표시됩니다 -->
                    </div>
                    
                    <!-- 데이터 테이블 (Tabulator) -->
                    <div id="data-table" style="min-height: 400px;"></div>
                    
                    <!-- 페이지네이션은 Tabulator가 자동으로 처리 -->
                </div>
                
                <div id="raw-data-view" style="display: none;">
                    <pre><code id="raw-data-content" class="language-json"></code></pre>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentData = [];
    let currentCategory = 'animals';
    let currentPage = 1;
    let itemsPerPage = 20;
    let isRawView = false;
    let currentLanguage = 'en';
    
    // 페이지 로드시 초기 데이터 로드
    document.addEventListener('DOMContentLoaded', function() {
        loadDataCategory('fields');
        
        // 검색 입력 이벤트
        document.getElementById('search-input').addEventListener('input', function() {
            filterData();
        });
    });
    
    // 데이터 카테고리 로드
    function loadDataCategory(category, element) {
        currentCategory = category;
        currentPage = 1;
        
        // 활성 버튼 변경
        document.querySelectorAll('.list-group-item').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // element가 전달되면 해당 요소를 활성화, 아니면 현재 클릭된 요소를 찾음
        const activeBtn = element || document.querySelector(`[onclick*="${category}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }
        
        // 로딩 표시
        document.getElementById('data-loading').style.display = 'block';
        document.getElementById('data-content').style.display = 'none';
        document.getElementById('raw-data-view').style.display = 'none';
        
        let apiUrl = '';
        let title = '';
        
        switch(category) {
            // 농작물 & 기본 데이터
            case 'fields':
                apiUrl = '/api/csv-data/fields';
                title = '밭/작물 데이터';
                break;
            case 'fruits':
                apiUrl = '/api/csv-data/fruits';
                title = '과일 데이터';
                break;
            case 'fruit_trees':
                apiUrl = '/api/csv-data/fruit_trees';
                title = '과일나무 데이터';
                break;
            case 'animals':
                apiUrl = '/api/csv-data/Animals';
                title = '동물 데이터';
                break;
            case 'levels':
                apiUrl = '/api/csv-data/Levels';
                title = '레벨 시스템';
                break;
            
            // 생산 건물별 상품
            case 'bakery_goods':
                apiUrl = '/api/csv-data/bakery_goods';
                title = '제과점 상품';
                break;
            case 'dairy_goods':
                apiUrl = '/api/csv-data/dairy_goods';
                title = '유제품 공장';
                break;
            case 'cafe_goods':
                apiUrl = '/api/csv-data/cafe_goods';
                title = '카페 상품';
                break;
            case 'barbecue_grill_goods':
                apiUrl = '/api/csv-data/barbecue_grill_goods';
                title = '바베큐 그릴';
                break;
            case 'juice_press_goods':
                apiUrl = '/api/csv-data/juice_press_goods';
                title = '주스 프레스';
                break;
            case 'pie_oven_goods':
                apiUrl = '/api/csv-data/pie_oven_goods';
                title = '파이 오븐';
                break;
            case 'loom_goods':
                apiUrl = '/api/csv-data/loom_goods';
                title = '직조기';
                break;
            case 'smelter_goods':
                apiUrl = '/api/csv-data/smelter_goods';
                title = '제련소';
                break;
            case 'sugar_mill_goods':
                apiUrl = '/api/csv-data/sugar_mill_goods';
                title = '설탕 공장';
                break;
            case 'ice_cream_maker_goods':
                apiUrl = '/api/csv-data/ice_cream_maker_goods';
                title = '아이스크림 머신';
                break;
            
            // 특수 생산
            case 'fishing_goods':
                apiUrl = '/api/csv-data/fishing_goods';
                title = '낚시 상품';
                break;
            case 'mine_goods':
                apiUrl = '/api/csv-data/mine_goods';
                title = '광산 상품';
                break;
            case 'animal_goods':
                apiUrl = '/api/csv-data/animal_goods';
                title = '동물 생산품';
                break;
            
            // 주문 & 배송 시스템
            case 'orders':
                apiUrl = '/api/csv-data/orders';
                title = '주문 데이터';
                break;
            case 'order_tables':
                apiUrl = '/api/csv-data/order_tables';
                title = '주문 테이블';
                break;
            case 'boats':
                apiUrl = '/api/csv-data/boats';
                title = '보트 주문';
                break;
            case 'train':
                apiUrl = '/api/csv-data/train';
                title = '기차 주문';
                break;
            
            // 건물 & 시설 시스템
            case 'processing_buildings':
                apiUrl = '/api/csv-data/processing_buildings';
                title = '생산 건물 (슬롯포함)';
                break;
            case 'production_buildings_goods':
                apiUrl = '/api/csv-data/production_buildings_goods';
                title = '건물별 생산품';
                break;
            case 'exp_levels':
                apiUrl = '/api/csv-data/exp_levels';
                title = '경험치 & 레벨업';
                break;
            
            // 통합 보기
            case 'all_goods':
                apiUrl = '/api/production-chains';
                title = '모든 생산품 (통합)';
                break;
            case 'balancing':
                apiUrl = '/api/balancing-policies';
                title = '밸런싱 정책';
                break;
        }
        
        document.getElementById('data-title').innerHTML = `<i class="fas fa-table me-2"></i>${title}`;
        
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('data-loading').innerHTML = 
                        `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                
                // 밸런싱 정책의 경우 특별 처리
                if (category === 'balancing') {
                    currentData = [];
                    for (const [key, policies] of Object.entries(data)) {
                        policies.forEach(policy => {
                            currentData.push({ ...policy, _category: key });
                        });
                    }
                } else {
                    currentData = Array.isArray(data) ? data : [data];
                }
                
                displayData();
                document.getElementById('data-loading').style.display = 'none';
                document.getElementById('data-content').style.display = 'block';
            })
            .catch(error => {
                document.getElementById('data-loading').innerHTML = 
                    `<div class="alert alert-danger">데이터 로드 실패: ${error.message}</div>`;
            });
    }
    
    // 데이터 표시
    function displayData() {
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        let pageData = currentData.slice(startIndex, endIndex);
        
        // 로컬라이제이션 적용
        const localizedData = applyLocalization(currentData);
        
        // 요약 정보
        updateDataSummary();
        
        // 테이블 생성 (전체 데이터로 - Tabulator가 페이지네이션 처리)
        createDataTable(localizedData);
    }
    
    // 데이터 요약 업데이트
    function updateDataSummary() {
        const summary = document.getElementById('data-summary');
        summary.innerHTML = `
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h5>${formatNumber(currentData.length)}</h5>
                        <small>총 레코드 수</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h5>${currentData.length > 0 ? Object.keys(currentData[0]).length : 0}</h5>
                        <small>컬럼 수</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h5>${currentPage}</h5>
                        <small>현재 페이지</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h5>${Math.ceil(currentData.length / itemsPerPage)}</h5>
                        <small>총 페이지</small>
                    </div>
                </div>
            </div>
        `;
    }
    
    // 컬럼명 번역
    function translateColumnName(columnName) {
        const translations = {
            'Name': '이름',
            'ToolIconExportName': '아이콘',
            'TID': 'ID',
            'TimeMin': '생산시간(분)',
            'OrderPrice': '주문가격',
            'OrderExp': '주문경험치',
            'ExpCollect': '수집경험치',
            'OrderValue': '주문가치',
            'BoatOrderValue': '보트가치',
            'ProcessingBuilding': '생산건물',
            'UnlockLevel': '해금레벨',
            'Difficulty': '난이도',
            'RequirementAmount': '필요수량',
            'Requirement': '필요재료',
            'unlock_level': '해금레벨',
            'level': '레벨',
            'sell_price': '판매가격',
            'efficiency_per_min': '분당효율',
            'building_type': '건물타입',
            'ingredients_text': '필요재료'
        };
        return translations[columnName] || columnName;
    }
    
    // 전역 Tabulator 인스턴스
    let currentTable = null;
    
    // 데이터 테이블 생성 (Tabulator 사용)
    function createDataTable(data) {
        if (data.length === 0) {
            document.getElementById('data-table').innerHTML = '<div class="text-center p-4">데이터가 없습니다.</div>';
            return;
        }
        
        // 기존 테이블 제거
        if (currentTable) {
            currentTable.destroy();
        }
        
        // 컬럼 정의 생성
        let headers = Object.keys(data[0]);
        
        // 저장된 컬럼 순서 불러오기
        const savedOrder = localStorage.getItem(`column_order_${currentCategory}`);
        if (savedOrder) {
            try {
                const parsedOrder = JSON.parse(savedOrder);
                // 저장된 순서가 유효한지 확인
                if (parsedOrder.every(field => headers.includes(field))) {
                    // 저장된 순서에 없는 새 컬럼들을 뒤에 추가
                    const newHeaders = headers.filter(h => !parsedOrder.includes(h));
                    headers = [...parsedOrder, ...newHeaders];
                }
            } catch (e) {
                console.warn('저장된 컬럼 순서를 불러오는데 실패했습니다:', e);
            }
        }
        
        const columns = headers.map(header => ({
            title: translateColumnName(header),
            field: header,
            sorter: "string",
            headerFilter: "input",
            headerFilterPlaceholder: "검색...",
            formatter: function(cell, formatterParams) {
                let value = cell.getValue();
                
                // 값 포맷팅
                if (typeof value === 'number' && value > 1000) {
                    value = formatNumber(value);
                } else if (typeof value === 'object' && value !== null) {
                    value = JSON.stringify(value);
                } else if (value === null || value === undefined) {
                    value = '<span class="text-muted">-</span>';
                }
                
                return value;
            }
        }));
        
        // Tabulator 테이블 생성 - 개선된 스타일링
        currentTable = new Tabulator("#data-table", {
            data: data,
            columns: columns,
            layout: "fitDataTable", // 데이터에 맞게 자동 조정
            responsiveLayout: "collapse",
            responsiveLayoutCollapseStartOpen: false,
            pagination: "local",
            paginationSize: itemsPerPage,
            paginationSizeSelector: [10, 25, 50, 100],
            movableColumns: true, // 컬럼 드래그앤드롭 활성화
            resizableColumns: true,
            headerFilterLiveFilterDelay: 300,
            rowHeight: 45, // 행 높이 증가
            minHeight: 500, // 최소 높이 설정
            locale: "ko",
            langs: {
                "ko": {
                    "pagination": {
                        "page_size": "페이지당 행 수",
                        "first": "첫 페이지",
                        "first_title": "첫 페이지로 이동",
                        "last": "마지막",
                        "last_title": "마지막 페이지로 이동",
                        "prev": "이전",
                        "prev_title": "이전 페이지로 이동",
                        "next": "다음",
                        "next_title": "다음 페이지로 이동"
                    }
                }
            }
        });
        
        // 컬럼 순서 변경 시 설정 저장
        currentTable.on("columnMoved", function(column, columns){
            const columnOrder = columns.map(col => col.getField());
            localStorage.setItem(`column_order_${currentCategory}`, JSON.stringify(columnOrder));
            showToast('컬럼 순서가 저장되었습니다!', 'success');
        });
    }
    
    // 컬럼 순서 초기화
    function resetColumnOrder() {
        if (confirm('컬럼 순서를 초기 상태로 되돌리시겠습니까?')) {
            localStorage.removeItem(`column_order_${currentCategory}`);
            showToast('컬럼 순서가 초기화되었습니다.', 'info');
            // 현재 데이터 다시 로드
            displayData();
        }
    }
    
    // 페이지네이션 생성
    function createPagination() {
        const totalPages = Math.ceil(currentData.length / itemsPerPage);
        const pagination = document.getElementById('pagination');
        
        if (totalPages <= 1) {
            document.getElementById('pagination-nav').style.display = 'none';
            return;
        }
        
        document.getElementById('pagination-nav').style.display = 'block';
        
        let paginationHTML = '';
        
        // 이전 버튼
        paginationHTML += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <button class="page-link" onclick="changePage(${currentPage - 1})">이전</button>
            </li>
        `;
        
        // 페이지 번호
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <button class="page-link" onclick="changePage(${i})">${i}</button>
                </li>
            `;
        }
        
        // 다음 버튼
        paginationHTML += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <button class="page-link" onclick="changePage(${currentPage + 1})">다음</button>
            </li>
        `;
        
        pagination.innerHTML = paginationHTML;
    }
    
    // 페이지 변경
    function changePage(page) {
        const totalPages = Math.ceil(currentData.length / itemsPerPage);
        if (page < 1 || page > totalPages) return;
        
        currentPage = page;
        displayData();
    }
    
    // 데이터 필터링
    function filterData() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        
        if (searchTerm === '') {
            displayData();
            return;
        }
        
        const filteredData = currentData.filter(row => {
            return Object.values(row).some(value => 
                String(value).toLowerCase().includes(searchTerm)
            );
        });
        
        // 임시로 현재 데이터를 필터된 데이터로 교체
        const originalData = currentData;
        currentData = filteredData;
        currentPage = 1;
        displayData();
        currentData = originalData;
    }
    
    // 원본 데이터 보기 토글
    function toggleRawView() {
        isRawView = !isRawView;
        
        if (isRawView) {
            document.getElementById('data-content').style.display = 'none';
            document.getElementById('raw-data-view').style.display = 'block';
            document.getElementById('raw-data-content').textContent = JSON.stringify(currentData, null, 2);
        } else {
            document.getElementById('data-content').style.display = 'block';
            document.getElementById('raw-data-view').style.display = 'none';
        }
    }
    
    // 데이터 새로고침
    function refreshData() {
        loadDataCategory(currentCategory);
    }
    
    // 현재 데이터 내보내기
    function exportCurrentData() {
        const dataStr = JSON.stringify(currentData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `hayday_${currentCategory}_data.json`;
        link.click();
        
        showToast('데이터 내보내기 완료!', 'success');
    }
    
    // 언어 변경
    function changeLanguage() {
        currentLanguage = document.getElementById('language-select').value;
        // 현재 카테고리 다시 로드
        loadDataCategory(currentCategory);
    }
    
    // 데이터에 로컬라이제이션 적용
    function applyLocalization(data) {
        if (!data || data.length === 0) return data;
        
        return data.map(item => {
            let localizedItem = { ...item };
            
            // 모든 TID 관련 컬럼 로컬라이제이션
            for (const key in item) {
                if (key.endsWith('_KR') || key.endsWith('_EN')) {
                    const baseKey = key.replace('_KR', '').replace('_EN', '');
                    
                    if (currentLanguage === 'kr' && key.endsWith('_KR') && item[key]) {
                        localizedItem[baseKey] = item[key];
                        // 대소문자 변형도 처리
                        localizedItem[baseKey.toLowerCase()] = item[key];
                        if (baseKey === 'Name') {
                            localizedItem.name = item[key];
                        }
                    } else if (currentLanguage === 'en' && key.endsWith('_EN') && item[key]) {
                        localizedItem[baseKey] = item[key];
                        // 대소문자 변형도 처리
                        localizedItem[baseKey.toLowerCase()] = item[key];
                        if (baseKey === 'Name') {
                            localizedItem.name = item[key];
                        }
                    }
                }
            }
            
            // Feed(사료) 컬럼 로컬라이제이션 (있는 경우)
            if (item.feed && currentLanguage === 'kr') {
                // 사료 이름도 번역 가능하면 적용
                localizedItem.feed = translateFeedName(item.feed);
            }
            
            // Good(생산품) 컬럼 로컬라이제이션 (있는 경우)
            if (item.good && currentLanguage === 'kr') {
                localizedItem.good = translateGoodName(item.good);
            }
            
            return localizedItem;
        });
    }
    
    // 사료 이름 번역
    function translateFeedName(feedName) {
        const feedTranslations = {
            'Chicken Food': '닭 사료',
            'Cow Food': '소 사료',
            'Sheep Food': '양 사료',
            'Pig Food': '돼지 사료',
            'Goat Food': '염소 사료'
        };
        return feedTranslations[feedName] || feedName;
    }
    
    // 생산품 이름 번역
    function translateGoodName(goodName) {
        const goodTranslations = {
            'Egg': '달걀',
            'Milk': '우유',
            'Wool': '양모',
            'Bacon': '베이컨',
            'Goat Milk': '염소 우유'
        };
        return goodTranslations[goodName] || goodName;
    }

    // 사이드바 토글 기능
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const toggleBtn = document.getElementById('sidebarToggle');
        const icon = toggleBtn.querySelector('i');
        
        sidebar.classList.toggle('collapsed');
        
        if (sidebar.classList.contains('collapsed')) {
            // 접힘 - 사이드바 숨기고 메인 콘텐츠 전체 너비 사용
            sidebar.style.display = 'none';
            mainContent.className = 'col-12';
            icon.className = 'fas fa-chevron-right';
        } else {
            // 펼침 - 사이드바 보이고 원래 Grid 레이아웃 복원
            sidebar.style.display = 'block';
            mainContent.className = 'col-md-9 col-lg-10';
            icon.className = 'fas fa-chevron-left';
        }
        
        // 테이블 리사이즈 트리거 (Tabulator 테이블이 새 너비에 맞게 조정되도록)
        if (currentTable) {
            setTimeout(() => {
                currentTable.redraw(true);
            }, 300);
        }
    }

    // Streamlit 열기
    function openStreamlit() {
        window.open('http://localhost:8501', '_blank');
    }

    // Streamlit 연결 상태 확인
    function updateConnectionStatus() {
        fetch('/api/streamlit-sync')
            .then(response => response.json())
            .then(data => {
                const status = document.getElementById('connectionStatus');
                if (data.streamlit_status === 'online') {
                    status.className = 'badge bg-success';
                    status.textContent = '🟢 Streamlit 연결됨';
                } else {
                    status.className = 'badge bg-warning';
                    status.textContent = '🟡 Streamlit 오프라인';
                }
            })
            .catch(error => {
                const status = document.getElementById('connectionStatus');
                status.className = 'badge bg-danger';
                status.textContent = '🔴 연결 실패';
            });
    }

    // 페이지 로드 시 추가 초기화
    document.addEventListener('DOMContentLoaded', function() {
        // 사이드바 토글 이벤트 리스너
        if (document.getElementById('sidebarToggle')) {
            document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
        }
        
        // 연결 상태 확인
        updateConnectionStatus();
        
        // 정기적으로 연결 상태 확인
        setInterval(updateConnectionStatus, 30000); // 30초마다 확인
    });
</script>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
#sidebar {
    transition: all 0.3s ease;
    position: relative;
}

#sidebar.collapsed {
    display: none;
}

#mainContent {
    transition: all 0.3s ease;
    padding-left: 15px;
    padding-right: 15px;
}

.list-group-item {
    border: none;
    margin-bottom: 2px;
    border-radius: 8px;
}

.list-group-item:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
}

.list-group-item.active {
    background-color: #2E7D32;
    color: white;
}

.list-group-item.active:hover {
    background-color: #1B5E20;
}
/* Tabulator 테이블 스타일링 개선 */
.tabulator {
    font-size: 14px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
}

.tabulator .tabulator-header {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
}

.tabulator .tabulator-header .tabulator-col {
    background-color: #f8f9fa;
    border-right: 1px solid #dee2e6;
    padding: 12px 8px;
    font-weight: 600;
    color: #495057;
}

.tabulator .tabulator-header .tabulator-col:hover {
    background-color: #e9ecef;
}

.tabulator-row {
    border-bottom: 1px solid #f1f3f4;
    min-height: 45px;
}

.tabulator-row:hover {
    background-color: #f8f9fa;
}

.tabulator-row:nth-child(even) {
    background-color: #fafbfc;
}

.tabulator-cell {
    padding: 12px 8px;
    border-right: 1px solid #f1f3f4;
    vertical-align: middle;
    line-height: 1.4;
}

.tabulator-pagination {
    padding: 15px;
    background-color: #f8f9fa;
    border-top: 1px solid #dee2e6;
}

.tabulator-page {
    margin: 0 3px;
    padding: 8px 12px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    background-color: white;
}

.tabulator-page.active {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
}

.tabulator-page:hover {
    background-color: #e9ecef;
}

/* 헤더 필터 스타일링 */
.tabulator-header-filter input {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 12px;
}

/* 반응형 접기/펼치기 버튼 스타일링 */
.tabulator-responsive-collapse-toggle {
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    font-size: 12px;
}

/* 데이터가 없을 때 메시지 스타일링 */
.tabulator-placeholder {
    padding: 40px;
    text-align: center;
    color: #6c757d;
    font-style: italic;
}
</style>
{% endblock %}